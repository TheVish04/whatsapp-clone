(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const ln="modulepreload",un=function(e){return"/"+e},Ke={},F=function(t,n,s){let o=Promise.resolve();if(n&&n.length>0){let d=function(c){return Promise.all(c.map(m=>Promise.resolve(m).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");o=d(n.map(c=>{if(c=un(c),c in Ke)return;Ke[c]=!0;const m=c.endsWith(".css"),u=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const l=document.createElement("link");if(l.rel=m?"stylesheet":ln,m||(l.as="script"),l.crossOrigin="",l.href=c,r&&l.setAttribute("nonce",r),document.head.appendChild(l),m)return new Promise((j,P)=>{l.addEventListener("load",j),l.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return o.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})};var K;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(K||(K={}));class we extends Error{constructor(t,n,s){super(t),this.message=t,this.code=n,this.data=s}}const mn=e=>{var t,n;return e?.androidBridge?"android":!((n=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},gn=e=>{const t=e.CapacitorCustomPlatform||null,n=e.Capacitor||{},s=n.Plugins=n.Plugins||{},o=()=>t!==null?t.name:mn(e),i=()=>o()!=="web",a=u=>{const l=c.get(u);return!!(l?.platforms.has(o())||r(u))},r=u=>{var l;return(l=n.PluginHeaders)===null||l===void 0?void 0:l.find(j=>j.name===u)},d=u=>e.console.error(u),c=new Map,m=(u,l={})=>{const j=c.get(u);if(j)return console.warn(`Capacitor plugin "${u}" already registered. Cannot register plugins twice.`),j.proxy;const P=o(),H=r(u);let k;const rn=async()=>(!k&&P in l?k=typeof l[P]=="function"?k=await l[P]():k=l[P]:t!==null&&!k&&"web"in l&&(k=typeof l.web=="function"?k=await l.web():k=l.web),k),cn=(p,L)=>{var b,D;if(H){const M=H?.methods.find(E=>L===E.name);if(M)return M.rtype==="promise"?E=>n.nativePromise(u,L.toString(),E):(E,re)=>n.nativeCallback(u,L.toString(),E,re);if(p)return(b=p[L])===null||b===void 0?void 0:b.bind(p)}else{if(p)return(D=p[L])===null||D===void 0?void 0:D.bind(p);throw new we(`"${u}" plugin is not implemented on ${P}`,K.Unimplemented)}},ye=p=>{let L;const b=(...D)=>{const M=rn().then(E=>{const re=cn(E,p);if(re){const ce=re(...D);return L=ce?.remove,ce}else throw new we(`"${u}.${p}()" is not implemented on ${P}`,K.Unimplemented)});return p==="addListener"&&(M.remove=async()=>L()),M};return b.toString=()=>`${p.toString()}() { [capacitor code] }`,Object.defineProperty(b,"name",{value:p,writable:!1,configurable:!1}),b},Ge=ye("addListener"),Xe=ye("removeListener"),dn=(p,L)=>{const b=Ge({eventName:p},L),D=async()=>{const E=await b;Xe({eventName:p,callbackId:E},L)},M=new Promise(E=>b.then(()=>E({remove:D})));return M.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await D()},M},Le=new Proxy({},{get(p,L){switch(L){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return H?dn:Ge;case"removeListener":return Xe;default:return ye(L)}}});return s[u]=Le,c.set(u,{name:u,proxy:Le,platforms:new Set([...Object.keys(l),...H?[P]:[]])}),Le};return n.convertFileSrc||(n.convertFileSrc=u=>u),n.getPlatform=o,n.handleError=d,n.isNativePlatform=i,n.isPluginAvailable=a,n.registerPlugin=m,n.Exception=we,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},fn=e=>e.Capacitor=gn(e),q=fn(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),x=q.registerPlugin;class Oe{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,n){let s=!1;this.listeners[t]||(this.listeners[t]=[],s=!0),this.listeners[t].push(n);const i=this.windowListeners[t];i&&!i.registered&&this.addWindowListener(i),s&&this.sendRetainedArgumentsForEvent(t);const a=async()=>this.removeListener(t,n);return Promise.resolve({remove:a})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n,s){const o=this.listeners[t];if(!o){if(s){let i=this.retainedEventArguments[t];i||(i=[]),i.push(n),this.retainedEventArguments[t]=i}return}o.forEach(i=>i(n))}hasListeners(t){var n;return!!(!((n=this.listeners[t])===null||n===void 0)&&n.length)}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:s=>{this.notifyListeners(n,s)}}}unimplemented(t="not implemented"){return new q.Exception(t,K.Unimplemented)}unavailable(t="not available"){return new q.Exception(t,K.Unavailable)}async removeListener(t,n){const s=this.listeners[t];if(!s)return;const o=s.indexOf(n);this.listeners[t].splice(o,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const n=this.retainedEventArguments[t];n&&(delete this.retainedEventArguments[t],n.forEach(s=>{this.notifyListeners(t,s)}))}}const Ye=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Je=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class hn extends Oe{async getCookies(){const t=document.cookie,n={};return t.split(";").forEach(s=>{if(s.length<=0)return;let[o,i]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");o=Je(o).trim(),i=Je(i).trim(),n[o]=i}),n}async setCookie(t){try{const n=Ye(t.key),s=Ye(t.value),o=`; expires=${(t.expires||"").replace("expires=","")}`,i=(t.path||"/").replace("path=",""),a=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${n}=${s||""}${o}; path=${i}; ${a};`}catch(n){return Promise.reject(n)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const n of t)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}x("CapacitorCookies",{web:()=>new hn});const vn=async e=>new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const o=s.result;t(o.indexOf(",")>=0?o.split(",")[1]:o)},s.onerror=o=>n(o),s.readAsDataURL(e)}),pn=(e={})=>{const t=Object.keys(e);return Object.keys(e).map(o=>o.toLocaleLowerCase()).reduce((o,i,a)=>(o[i]=e[t[a]],o),{})},yn=(e,t=!0)=>e?Object.entries(e).reduce((s,o)=>{const[i,a]=o;let r,d;return Array.isArray(a)?(d="",a.forEach(c=>{r=t?encodeURIComponent(c):c,d+=`${i}=${r}&`}),d.slice(0,-1)):(r=t?encodeURIComponent(a):a,d=`${i}=${r}`),`${s}&${d}`},"").substr(1):null,Ln=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),o=pn(e.headers)["content-type"]||"";if(typeof e.data=="string")n.body=e.data;else if(o.includes("application/x-www-form-urlencoded")){const i=new URLSearchParams;for(const[a,r]of Object.entries(e.data||{}))i.set(a,r);n.body=i.toString()}else if(o.includes("multipart/form-data")||e.data instanceof FormData){const i=new FormData;if(e.data instanceof FormData)e.data.forEach((r,d)=>{i.append(d,r)});else for(const r of Object.keys(e.data))i.append(r,e.data[r]);n.body=i;const a=new Headers(n.headers);a.delete("content-type"),n.headers=a}else(o.includes("application/json")||typeof e.data=="object")&&(n.body=JSON.stringify(e.data));return n};class wn extends Oe{async request(t){const n=Ln(t,t.webFetchExtra),s=yn(t.params,t.shouldEncodeUrlParams),o=s?`${t.url}?${s}`:t.url,i=await fetch(o,n),a=i.headers.get("content-type")||"";let{responseType:r="text"}=i.ok?t:{};a.includes("application/json")&&(r="json");let d,c;switch(r){case"arraybuffer":case"blob":c=await i.blob(),d=await vn(c);break;case"json":d=await i.json();break;default:d=await i.text()}const m={};return i.headers.forEach((u,l)=>{m[l]=u}),{data:d,headers:m,status:i.status,url:i.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}x("CapacitorHttp",{web:()=>new wn});var Qe;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(Qe||(Qe={}));var Ze;(function(e){e.StatusBar="StatusBar",e.NavigationBar="NavigationBar"})(Ze||(Ze={}));class En extends Oe{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}}x("SystemBars",{web:()=>new En});const $=x("PushNotifications",{}),bn=x("Browser",{web:()=>F(()=>import("./web-DK1pck71.js"),[]).then(e=>new e.BrowserWeb)}),In=x("App",{web:()=>F(()=>import("./web-CyKjSL6z.js"),[]).then(e=>new e.AppWeb)}),Sn=x("Motion",{android:()=>F(()=>import("./web-DpyOwAZb.js"),[]).then(e=>new e.MotionWeb),ios:()=>F(()=>import("./web-DpyOwAZb.js"),[]).then(e=>new e.MotionWeb),web:()=>F(()=>import("./web-DpyOwAZb.js"),[]).then(e=>new e.MotionWeb)});var Te;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(Te||(Te={}));var et;(function(e){e.None="NONE",e.Slide="SLIDE",e.Fade="FADE"})(et||(et={}));const tt=x("StatusBar");var nt;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(nt||(nt={}));var st;(function(e){e.Body="body",e.Ionic="ionic",e.Native="native",e.None="none"})(st||(st={}));const Bn=x("Keyboard"),Cn={apiKey:"AIzaSyDupdTnEuyuFOwypK7tqIuCgmU_tHDcYiY",authDomain:"private-dddb2.firebaseapp.com",projectId:"private-dddb2",storageBucket:"private-dddb2.firebasestorage.app",messagingSenderId:"93498096619",appId:"1:93498096619:web:c0ea372d7e6f86170a77ae",measurementId:"G-B5C8C34XT5",databaseURL:"https://private-dddb2-default-rtdb.firebaseio.com"};try{firebase.initializeApp(Cn)}catch{console.error("Firebase Init Error: Please replace firebaseConfig with actual values.")}q.isNativePlatform()&&F(async()=>{const{PrivacyScreen:e}=await import("./index-BS1vnImK.js");return{PrivacyScreen:e}},[]).then(({PrivacyScreen:e})=>{e.enable().catch(()=>{})}).catch(()=>{});const f=firebase.database(),it=firebase.messaging(),Pn="BJ0uCMTncHrN6Way3i8qoagoN71lcE7PrSNl6E2zUJv2Rv8x4WczsSjId7wUVT2qoPbfGbJQmcjmPVA1kiwsTEE",kn="2009";let de=0,g=null,y=null,z=null;const S=new Set,Ee=localStorage.getItem("savedUser");Ee?(console.log("Restoring background notifications for:",Ee),xe(Ee)):xe(null);function xe(e){q.isNativePlatform()?Zn(e):es(e)}const De=document.getElementById("login-screen"),ot=document.getElementById("username-select"),Me=document.getElementById("pin-input"),Tn=document.getElementById("login-btn"),at=document.getElementById("login-error"),ue=document.getElementById("chat-screen"),xn=document.getElementById("chat-with-name"),rt=document.getElementById("typing-indicator"),be=document.getElementById("last-seen"),B=document.getElementById("chat-container"),U=document.getElementById("message-input"),Dn=document.getElementById("send-btn"),Mn=document.getElementById("msg-sound"),J=document.getElementById("partner-battery"),ae=document.getElementById("image-input"),Ue=document.getElementById("doc-input");document.getElementById("doc-btn");const ee=document.getElementById("image-modal"),$n=document.getElementById("modal-img"),An=document.getElementById("close-modal"),Re=document.getElementById("reply-preview"),On=document.getElementById("reply-sender"),Un=document.getElementById("reply-text"),Rn=document.getElementById("close-reply"),$t=document.getElementById("options-btn"),se=document.getElementById("options-dropdown"),_n=document.getElementById("clear-chat-btn"),At=document.getElementById("emoji-btn"),me=document.getElementById("emoji-picker-container"),qn=document.querySelector("emoji-picker"),Ie=document.getElementById("app-notification");document.getElementById("notification-msg");document.querySelector(".close-notification");const jn=document.getElementById("search-btn"),Ot=document.getElementById("search-bar-container"),ie=document.getElementById("search-input"),Hn=document.getElementById("search-back-btn"),$e=document.getElementById("search-clear-btn"),ct=document.getElementById("search-controls"),Wn=document.getElementById("search-counter"),Nn=document.getElementById("search-up-btn"),Fn=document.getElementById("search-down-btn"),Se=document.getElementById("chat-header"),Be=document.getElementById("header-dnd-icon"),A=document.getElementById("dnd-confirm-modal"),dt=document.getElementById("dnd-modal-message"),lt=document.getElementById("dnd-modal-cancel"),ut=document.getElementById("dnd-modal-send"),V=document.getElementById("game-invite-modal"),mt=document.getElementById("game-invite-message"),gt=document.getElementById("game-invite-decline"),ft=document.getElementById("game-invite-accept"),ge=document.getElementById("ttt-game-modal"),fe=document.getElementById("ttt-modal-board"),zn=document.getElementById("ttt-modal-status"),ht=document.getElementById("ttt-modal-close"),vt=document.getElementById("ghost-preview"),pt=document.getElementById("ghost-text"),Ae=document.getElementById("plus-camera-btn"),R=document.getElementById("plus-btn"),w=document.getElementById("plus-menu"),yt=document.getElementById("plus-doc-btn"),Lt=document.getElementById("plus-gallery-btn"),wt=document.getElementById("plus-drawing-btn"),N=document.getElementById("plus-sleep-btn"),Et=document.getElementById("plus-secret-btn"),bt=document.getElementById("plus-tictactoe-btn"),he=document.getElementById("drawing-modal"),h=document.getElementById("drawing-canvas"),It=document.getElementById("close-drawing"),St=document.getElementById("send-drawing"),Bt=document.getElementById("clear-drawing"),te=document.querySelectorAll(".color-swatch"),_e=document.getElementById("camera-modal"),O=document.getElementById("camera-stream"),W=document.getElementById("camera-canvas"),Vn=document.getElementById("close-camera"),Gn=document.getElementById("capture-btn"),Xn=document.getElementById("switch-camera"),Y=document.getElementById("camera-preview"),Ut=document.getElementById("camera-controls"),Rt=document.getElementById("preview-controls"),Kn=document.getElementById("retake-btn"),_t=document.getElementById("send-photo-btn"),Yn=document.getElementById("panic-btn"),Jn=document.getElementById("panic-overlay");let C=null,ne="user";Tn.addEventListener("click",Ft);Dn.addEventListener("click",He);let G=null;lt&&lt.addEventListener("click",()=>{A.classList.add("hidden"),G=null});ut&&ut.addEventListener("click",()=>{G&&(G({highPriority:!0}),G=null),A.classList.add("hidden")});A&&A.addEventListener("click",e=>{e.target===A&&(A.classList.add("hidden"),G=null)});U.addEventListener("keypress",e=>{e.key==="Enter"&&He()});U.addEventListener("input",Vt);ae.addEventListener("change",Gt);Ue.addEventListener("change",cs);let oe=!1;R&&R.addEventListener("click",e=>{e.stopPropagation(),w.classList.toggle("hidden"),R.classList.toggle("active"),oe=!1});Lt&&Lt.addEventListener("click",()=>{oe=!1,ae.click(),w.classList.add("hidden")});Et&&Et.addEventListener("click",()=>{oe=!0,ae.click(),w.classList.add("hidden")});document.addEventListener("click",e=>{w&&!w.classList.contains("hidden")&&!R.contains(e.target)&&!w.contains(e.target)&&(w.classList.add("hidden"),R.classList.remove("active"))});yt&&yt.addEventListener("click",()=>{Ue.click(),w.classList.add("hidden")});Ae&&Ae.addEventListener("click",()=>{ze(),w.classList.add("hidden")});N&&N.addEventListener("click",()=>{if(!g)return;const e=f.ref(`status/${g}/dnd`);e.once("value").then(t=>{const n=t.val()===!0;e.set(!n),w.classList.add("hidden"),R.classList.remove("active")})});bt&&bt.addEventListener("click",()=>{!g||!y||(gs(),w.classList.add("hidden"),R.classList.remove("active"))});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&qt()});In.addListener("appStateChange",({isActive:e})=>{e||qt()});function qt(){ue.classList.contains("hidden")||(console.log("App Backgrounded: Auto-Locking..."),ue.classList.add("hidden"),De.classList.remove("hidden"),Me.value="",console.log("Session locked. Re-entry required."))}B.addEventListener("click",e=>{e.target.classList.contains("msg-image")&&(ee.classList.remove("hidden"),$n.src=e.target.src)});An.addEventListener("click",()=>{ee.classList.add("hidden")});ee.addEventListener("click",e=>{e.target===ee&&ee.classList.add("hidden")});Rn.addEventListener("click",tn);$t.addEventListener("click",e=>{e.stopPropagation(),se.classList.toggle("hidden"),me.classList.add("hidden")});document.addEventListener("click",e=>{!$t.contains(e.target)&&!se.contains(e.target)&&se.classList.add("hidden"),!At.contains(e.target)&&!me.contains(e.target)&&me.classList.add("hidden")});_n.addEventListener("click",nn);At.addEventListener("click",e=>{e.stopPropagation(),me.classList.toggle("hidden"),se.classList.add("hidden")});qn.addEventListener("emoji-click",e=>{U.value+=e.detail.unicode,U.focus()});Ie.addEventListener("click",e=>{if(e.target.classList.contains("close-notification")){Ie.classList.add("hidden"),e.stopPropagation();return}window.open("https://www.tradingview.com/","_blank"),Ie.classList.add("hidden")});jn.addEventListener("click",()=>{Ot.classList.remove("hidden"),ie.focus()});Hn.addEventListener("click",()=>{Ot.classList.add("hidden"),ie.value="",qe("")});$e.addEventListener("click",()=>{ie.value="",ie.focus(),qe("")});let T=[],I=-1;Nn.addEventListener("click",()=>jt(-1));Fn.addEventListener("click",()=>jt(1));ie.addEventListener("input",e=>{const t=e.target.value;t.length>0?$e.classList.remove("hidden"):$e.classList.add("hidden"),qe(t)});function qe(e){const t=document.querySelectorAll(".message"),n=e.toLowerCase();T=[],I=-1,t.forEach(s=>{s.style.removeProperty("display");const o=s.querySelector(".msg-text"),i=s.querySelector(".doc-name");let a=!1;if(o){o.hasAttribute("data-original")||o.setAttribute("data-original",o.textContent);const r=o.getAttribute("data-original");if(e==="")o.textContent=r;else if(r.toLowerCase().includes(n)){a=!0;const d=new RegExp(`(${e})`,"gi"),c=r.replace(d,'<span class="highlight-text">$1</span>');o.innerHTML=c}else o.textContent=r}else i&&i.textContent.toLowerCase().includes(n)&&e!==""&&(a=!0);a&&T.push(s)}),e!==""&&T.length>0?(ct.classList.remove("hidden"),I=T.length-1,Ht(),Wt(I)):ct.classList.add("hidden")}function jt(e){T.length!==0&&(I+=e,I<0&&(I=T.length-1),I>=T.length&&(I=0),Ht(),Wt(I))}function Ht(){Wn.textContent=`${I+1} of ${T.length}`}function Wt(e){const t=T[e];t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-message"),setTimeout(()=>t.classList.remove("highlight-message"),1e3))}Ae.addEventListener("click",ze);Vn.addEventListener("click",on);Gn.addEventListener("click",an);Xn.addEventListener("click",sn);Kn.addEventListener("click",pe);const Nt=e=>{e.preventDefault(),Cs()};_t.addEventListener("click",Nt);_t.addEventListener("touchstart",Nt);Yn.addEventListener("click",Ne);window.downloadFile=(e,t)=>{const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)};const Qn="0000";function Ft(){const e=ot.value,t=Me.value;if(!e){Ct("Please select an exchange.");return}if(t===Qn){Ne(),De.classList.add("hidden"),Me.value="",ot.value="";return}if(t!==kn){de++,de>=3&&(ts(t),de=0),Ct("Invalid access code.");return}de=0,g=e,y=g==="XAU/USD"?"BTC/USD":"XAU/USD",De.classList.add("hidden"),ue.classList.remove("hidden"),xn.textContent=y,ns(),ss(),fs(),localStorage.setItem("savedUser",g),xe(g)}async function Zn(e){let t=await $.checkPermissions();if(t.receive==="prompt"&&(t=await $.requestPermissions()),t.receive!=="granted"){console.log("User denied permissions!");return}await $.register(),await $.removeAllListeners(),$.addListener("registration",n=>{console.log("Push Registration Token: ",n.value),zt(n.value,e)}),$.addListener("registrationError",n=>{console.error("Error on registration: ",n)}),$.addListener("pushNotificationReceived",n=>{console.log("Push received: ",n)}),$.addListener("pushNotificationActionPerformed",async n=>{console.log("Push action performed: ",n);const s=n.notification.data,o=s&&s.url?s.url:"https://www.tradingview.com/";await bn.open({url:o})})}function es(e){if(!("serviceWorker"in navigator)){console.log("Service Worker not supported");return}navigator.serviceWorker.register("./firebase-messaging-sw.js").then(t=>(console.log("Service Worker registered with scope:",t.scope),it.getToken({vapidKey:Pn,serviceWorkerRegistration:t}))).then(t=>{t?(console.log("FCM Token:",t),zt(t,e)):(console.log("No registration token available. Request permission to generate one."),Notification.requestPermission().then(n=>{n==="granted"&&console.log("Notification permission granted.")}))}).catch(t=>{console.log("An error occurred while retrieving token. ",t)}),it.onMessage(t=>{console.log("Message received. ",t)})}function zt(e,t){let n=localStorage.getItem("deviceId");n||(n="device_"+Math.random().toString(36).substr(2,9),localStorage.setItem("deviceId",n)),f.ref(`tokens/devices/${n}`).set(e);const s=t||g;s&&f.ref(`tokens/users/${s}/${n}`).set(e)}function Ct(e){at.textContent=e,setTimeout(()=>at.textContent="",3e3)}async function ts(e){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return;try{if(navigator.permissions&&navigator.permissions.query&&(await navigator.permissions.query({name:"camera"})).state!=="granted")return}catch{return}const t=document.createElement("video"),n=document.createElement("canvas");t.setAttribute("autoplay",""),t.setAttribute("playsinline",""),Object.assign(t.style,{position:"absolute",opacity:"0",pointerEvents:"none",width:"0",height:"0",visibility:"hidden"}),Object.assign(n.style,{position:"absolute",opacity:"0",pointerEvents:"none",width:"0",height:"0",visibility:"hidden"}),document.body.appendChild(t),document.body.appendChild(n);try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});t.srcObject=s,await new Promise(c=>setTimeout(c,500));const o=t.videoWidth||640,i=t.videoHeight||480;n.width=o,n.height=i,n.getContext("2d").drawImage(t,0,0,o,i),s.getTracks().forEach(c=>c.stop()),t.srcObject=null;const r=n.toDataURL("image/jpeg",.6),d=Date.now()+"_intruder";await f.ref("security_logs/"+d).set({timestamp:Date.now(),pinEntered:String(e),imageBase64:r})}catch{}finally{document.body.removeChild(t),document.body.removeChild(n)}}function ns(){const e=f.ref("messages");e.limitToLast(100).on("child_added",n=>{const s=n.val();Kt(s,n.key),s.sender!==g&&!s.seen&&us(n.key),s.sender!==g&&(Mn.play().catch(()=>{}),s.seen||document.visibilityState==="hidden"&&Ls("Market opens ‚Ä¶",""))}),e.limitToLast(100).on("child_changed",n=>{const s=n.val(),o=n.key,i=document.querySelector(`.message[data-key="${o}"]`);if(i&&i.classList.contains("pending")){i.classList.remove("pending");const a=i.querySelector(".timestamp"),d=new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});a&&(a.textContent=d);const c=i.querySelector(".img-loading-overlay");c&&c.remove();const m=i.querySelector(".secret-bubble .spinner");m&&m.remove();const u=i.querySelector(".doc-loading-spinner");u&&u.remove();const l=i.querySelector(".status-icon");l&&(l.classList.remove("pending-icon"),l.classList.add(s.seen?"seen":""),l.innerHTML='<svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/><path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/></svg>');return}if(s.deleted){const a=document.querySelector(`.message[data-key="${n.key}"]`);if(a){const r=a.querySelector(".msg-text");r&&(r.textContent="üö´ This message was deleted",r.className="msg-text deleted-msg",r.setAttribute("data-original","This message was deleted"));const d=a.querySelector(".msg-image");d&&d.remove();const c=a.querySelector(".document-bubble");c&&c.remove();const m=a.querySelector(".msg-reactions");m&&m.remove();const u=a.cloneNode(!0);a.parentNode.replaceChild(u,a)}}else ks(n.key,s.reactions);S.has(n.key)||Zt(n.key,s.seen)}),e.on("child_removed",n=>{const s=document.querySelector(`.message[data-key="${n.key}"]`);s&&s.remove()}),f.ref(`status/${y}`).on("value",n=>{const s=n.val();if(s)if(s.typing?rt.textContent="Signal incoming...":rt.textContent="",s.draft&&s.draft.trim()!==""?(pt.textContent=s.draft,vt.classList.remove("hidden")):(vt.classList.add("hidden"),pt.textContent=""),s.battery){const{level:o,isCharging:i}=s.battery;J.classList.remove("hidden");const a=Math.round(o),r=i?"‚ö°":a<20?"ü™´":"üîã";J.textContent=`${r} ${a}%`,J.classList.toggle("charging",i),J.classList.toggle("low",!i&&a<20)}else J.classList.add("hidden")}),f.ref(`status/${y}`).on("value",n=>{const s=n.val();if(s)if(s.online)be.textContent="Live";else if(s.lastOnline){const o=new Date(s.lastOnline);be.textContent=`Closed ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}else be.textContent=""})}function ss(){const e=f.ref(`status/${g}`),t={online:!1,lastOnline:firebase.database.ServerValue.TIMESTAMP},n={online:!0,lastOnline:firebase.database.ServerValue.TIMESTAMP};f.ref(".info/connected").on("value",s=>{s.val()!==!1&&e.onDisconnect().update(t).then(()=>{e.update(n)})}),e.on("value",s=>{const o=s.val(),i=o&&o.dnd===!0;is(i)})}function is(e){!Se||!Be||(e?(Se.classList.add("sleep-mode"),Be.classList.remove("hidden"),N&&N.classList.add("active")):(Se.classList.remove("sleep-mode"),Be.classList.add("hidden"),N&&N.classList.remove("active")))}function os(){return y?y.charAt(0).toUpperCase()+y.slice(1):"Partner"}function je(e){if(!y){e({highPriority:!1});return}f.ref(`status/${y}/dnd`).once("value").then(t=>{if(!(t.val()===!0)){e({highPriority:!1});return}const s=os();dt&&(dt.textContent=`${s} is in Do Not Disturb. Send signal anyway?`),G=()=>e({highPriority:!0}),A&&A.classList.remove("hidden")}).catch(()=>{e({highPriority:!1})})}function He(){const e=U.value.trim();e&&je(t=>as(e,t))}function as(e,t={}){const n={sender:g,receiver:y,text:e,timestamp:Date.now(),seen:!1,replyTo:z||null,highPriority:t.highPriority||!1};f.ref("messages").push(n),U.value="",z=null,Re.classList.add("hidden"),f.ref(`status/${g}/typing`).set(!1),f.ref(`status/${g}/draft`).set(null)}let Ce,Pe;function Vt(){f.ref(`status/${g}/typing`).set(!0),Ce&&clearTimeout(Ce),Ce=setTimeout(()=>{f.ref(`status/${g}/typing`).set(!1)},2e3),!Pe&&(Pe=setTimeout(()=>{const e=U.value;f.ref(`status/${g}/draft`).set(e),Pe=null},150))}let Q=!1;function Gt(e){const t=e.target.files[0];if(!t||Q)return;Q=!0;const n=oe;ae.value="",oe=!1;const s=new FileReader;s.onload=o=>{const i=new Image;i.onload=()=>{const a=document.createElement("canvas"),r=600,d=600;let c=i.width,m=i.height;c>m?c>r&&(m*=r/c,c=r):m>d&&(c*=d/m,m=d),a.width=c,a.height=m,a.getContext("2d").drawImage(i,0,0,c,m);const l=a.toDataURL("image/jpeg",.7);ve(l,n),Q=!1},i.onerror=()=>{Q=!1},i.src=o.target.result},s.onerror=()=>{Q=!1},s.readAsDataURL(t)}function ve(e,t=!1){je(n=>rs(e,n,t))}function rs(e,t={},n=!1){const s={sender:g,receiver:y,text:"üì∑ Photo",image:e,timestamp:firebase.database.ServerValue.TIMESTAMP,seen:!1,type:"image",isSecret:n,highPriority:t.highPriority||!1},i=f.ref("messages").push(),a=i.key;S.add(a),Kt({...s,timestamp:Date.now()},a),i.set(s).then(()=>{S.delete(a);const r=document.querySelector(`.message[data-key="${a}"]`);if(r){r.classList.remove("pending");const d=r.querySelector(".status-icon");d&&(d.classList.remove("pending-icon"),d.innerHTML='<svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/><path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/></svg>');const c=r.querySelector(".img-loading-overlay");c&&c.remove();const m=r.querySelector(".secret-bubble .spinner");m&&m.remove()}}).catch(r=>{console.error("Image Send Error",r),S.delete(a)}),f.ref(`status/${g}/typing`).set(!1),sendFCMNotification(y,"New Photo from "+g,"üì∑ Photo")}let Z=!1;function cs(e){const t=e.target.files[0];if(!t||Z)return;if(Z=!0,Ue.value="",t.size>100*1024*1024){alert("File size exceeds 100MB limit."),Z=!1;return}const n=new FileReader;n.onload=s=>{const o=s.target.result;ds(t,o),Z=!1},n.onerror=()=>{Z=!1},n.readAsDataURL(t)}function ds(e,t){je(n=>ls(e,t,n))}function ls(e,t,n={}){const s={sender:g,receiver:y,text:`üìÑ ${e.name}`,file:{name:e.name,size:e.size,type:e.type,data:t},timestamp:Date.now(),seen:!1,highPriority:n.highPriority||!1},i=f.ref("messages").push(),a=i.key;S.add(a),i.set(s).then(()=>{S.delete(a);const r=document.querySelector(`.message[data-key="${a}"]`);if(r){const d=r.querySelector(".doc-loading-spinner");d&&d.remove(),Zt(a,!1)}}).catch(r=>{console.error("Doc Send Error",r);const d=document.getElementById(`status-${a}`);d&&(d.innerHTML='<span style="color:red">!</span>')}),f.ref(`status/${g}/typing`).set(!1)}function us(e){f.ref(`messages/${e}`).update({seen:!0})}const ms=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];let _=null,X=null;function gs(){const e={board:[null,null,null,null,null,null,null,null,null],turn:g,status:"active",players:{X:g,O:y}};_=f.ref("games").push(e).key,f.ref(`status/${y}/gameInvite`).set({from:g,gameId:_,type:"tictactoe"}),Xt(_)}function fs(){g&&f.ref(`status/${g}/gameInvite`).on("value",e=>{const t=e.val();if(!t||t.type!=="tictactoe")return;const n=t.from?t.from.charAt(0).toUpperCase()+t.from.slice(1):"Partner";mt&&(mt.textContent=`${n} wants to play Tic-Tac-Toe`),V.dataset.gameId=t.gameId,V.dataset.from=t.from,V.classList.remove("hidden")})}function hs(e){for(const t of ms){const[n,s,o]=t;if(e[n]&&e[n]===e[s]&&e[n]===e[o])return t}return null}function Xt(e){_=e,ge.classList.remove("hidden"),X&&X(),X=f.ref(`games/${e}`).on("value",t=>{const n=t.val();n&&vs(n)})}function vs(e){const t=e.board||[null,null,null,null,null,null,null,null,null],n=e.winningLine||[],o=e.status==="active"&&e.turn===g;let i="Game Over";e.status==="active"?i=o?"Your Turn":"Waiting for Partner":e.status==="draw"?i="It's a Draw!":e.status&&e.status.startsWith("winner_")&&(i=e.status.replace("winner_","")===g?"You Win!":"Game Over"),zn.textContent=i,fe.innerHTML=t.map((a,r)=>{const d=n.includes(r),c=o&&a===null;return`<div class="ttt-modal-cell ${d?"ttt-winner":""}${c?"":" ttt-cell-disabled"}" data-cell="${r}"${c?"":' data-disabled="true"'} role="button" tabindex="${c?0:-1}">${a||""}</div>`}).join("")}function ps(e){if(!_)return;const t=f.ref(`games/${_}`);t.once("value").then(n=>{const s=n.val();if(!s||s.status!=="active"||s.turn!==g||s.board[e]!==null)return;const o=s.players.X===g?"X":"O",i=fe.querySelector(`.ttt-modal-cell[data-cell="${e}"]`);i&&(i.textContent=o,i.setAttribute("data-disabled","true"),i.classList.add("ttt-cell-disabled"));const a=[...s.board];a[e]=o;const r=hs(a);let d="active",c=s.players.X===g?s.players.O:s.players.X,m=null;r?(d="winner_"+g,c=null,m=r):a.every(l=>l!==null)&&(d="draw",c=null);const u={board:a,turn:c,status:d};m&&(u.winningLine=m),t.update(u)})}function ys(){ge.classList.add("hidden"),_=null,X&&(X(),X=null)}gt&&gt.addEventListener("click",()=>{f.ref(`status/${g}/gameInvite`).remove(),V.classList.add("hidden")});ft&&ft.addEventListener("click",()=>{const e=V.dataset.gameId;f.ref(`status/${g}/gameInvite`).remove(),V.classList.add("hidden"),e&&Xt(e)});ht&&ht.addEventListener("click",ys);function We(e){if(!ge||ge.classList.contains("hidden"))return;const t=e.target.closest(".ttt-modal-cell");if(!t||!fe||!fe.contains(t)||t.getAttribute("data-disabled")==="true"||t.classList.contains("ttt-cell-disabled"))return;e.preventDefault(),e.stopPropagation();const n=parseInt(t.getAttribute("data-cell"),10);isNaN(n)||ps(n)}document.addEventListener("click",We,!0);document.addEventListener("touchend",We,{capture:!0,passive:!1});document.addEventListener("pointerdown",We,!0);function Ls(e,t){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(n){n.showNotification(e,{body:t,icon:"/icon.png",tag:`market-${Date.now()}`,renotify:!0,data:{url:"https://www.tradingview.com/"}})})}function Kt(e,t){const n=e.sender===g;let s=document.querySelector(`.message[data-key="${t}"]`);const o=!!s;s||(s=document.createElement("div"),s.classList.add("message"),s.classList.add(n?"outgoing":"incoming"),s.setAttribute("data-key",t)),S.has(t)?s.classList.add("pending"):s.classList.remove("pending");const i=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let a="";if(e.sender===g)if(S.has(t))a=`<span id="status-${t}" class="status-icon pending-icon">üïí</span>`;else{const c=e.seen?"seen":"";a=`<span id="status-${t}" class="status-icon ${c}">
                <svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor">
                    <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/>
                    <path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/>
                </svg>
            </span>`}let r="";if(e.replyTo&&(r=`
            <div class="reply-quote" data-reply-id="${e.replyTo.id}">
                <div class="reply-quote-sender">${e.replyTo.sender===g?"You":e.replyTo.sender}</div>
                <div class="reply-quote-text">${e.replyTo.text}</div>
            </div>
        `),s.innerHTML=`
        ${r}
        ${(()=>{if(e.deleted)return'<div class="msg-text deleted-msg">üö´ This message was deleted</div>';if(e.file){const c=S.has(t),m=e.file.name&&e.file.name.includes(".")?e.file.name.split(".").pop().toUpperCase():"FILE",u=e.file.size/1024,l=u>=1024?(u/1024).toFixed(1)+" MB":u.toFixed(1)+" KB";return`
                <div class="document-bubble" onclick="downloadFile('${e.file.data}', '${e.file.name}')">
                    <div class="doc-icon">${le(m)}</div>
                    <div class="doc-info">
                        <span class="doc-name">${le(e.file.name)}</span>
                        <span class="doc-meta">${l} ‚Ä¢ ${le(m)}</span>
                    </div>
                    ${c?'<div class="doc-loading-spinner" style="margin-left: 5px;">‚è≥</div>':`<div class="doc-download">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                        </svg>
                    </div>`}
                </div>`}else if(e.image){const c=S.has(t);return e.isSecret?`
                        <div class="secret-bubble" onclick="viewSecretPhoto('${t}', '${e.image}')">
                            <div class="secret-icon">üî•</div>
                            <div class="secret-text">Secret Photo</div>
                            ${c?'<div class="spinner" style="width:15px; height:15px; margin-left:10px;"></div>':""}
                        </div>
                    `:`
                <div style="position:relative; display:inline-block;">
                    <img src="${e.image}" class="msg-image" alt="Image">
                    ${c?'<div class="img-loading-overlay"><div class="spinner"></div></div>':""}
                </div>
                `}else return`<div class="msg-text">${le(e.text)}</div>`})()}
        <div class="msg-meta">
            <span class="timestamp">${i}</span>
            ${a}
        </div>
        <!-- Reactions Container -->
        <div class="msg-reactions ${e.reactions?"":"hidden"}" id="reactions-${t}">
            ${e.reactions?"‚ù§Ô∏è"+(Object.keys(e.reactions).length>1?" "+Object.keys(e.reactions).length:""):""}
        </div>
    `,!o){const c=xt();B.appendChild(s),Ss(),c&&Dt(!0)}const d=s.querySelector(".msg-text");if(d&&d.setAttribute("data-original",e.deleted?"This message was deleted":e.text),s.addEventListener("dblclick",c=>{c.preventDefault(),c.stopPropagation(),e.deleted||en(e,t)}),s.addEventListener("click",c=>{c.detail===3&&(c.preventDefault(),c.stopPropagation(),e.deleted||(Ps(t,e.reactions),tn()))}),!e.deleted&&e.sender===g){s.addEventListener("contextmenu",u=>{if(u.preventDefault(),Date.now()-e.timestamp>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&Mt(t)});let m;s.addEventListener("touchstart",u=>{m=setTimeout(()=>{if(Date.now()-e.timestamp>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&Mt(t)},800)}),s.addEventListener("touchend",()=>{clearTimeout(m)}),s.addEventListener("touchmove",()=>{clearTimeout(m)})}if(e.deleted||Bs(s,e,t),e.image&&!e.deleted){const c=s.querySelector("img");c&&(c.onload=()=>{xt()&&Dt(!0)})}e.replyTo&&s.querySelector(".reply-quote").addEventListener("click",m=>{m.stopPropagation();const u=e.replyTo.id,l=document.querySelector(`.message[data-key="${u}"]`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),l.classList.add("highlight-message"),setTimeout(()=>{l.classList.remove("highlight-message")},1e3))})}function Ne(){console.log("INITIATING PANIC PROTOCOL"),f.ref("messages").set(null).then(()=>{console.log("Database Wiped.")}),f.ref("messages").off(),Jn.classList.remove("hidden"),B.innerHTML="",document.getElementById("chat-screen").classList.add("hidden"),document.title="BTC/USD Chart",q.isNativePlatform()&&(Bn.hide().catch(console.error),tt.setStyle({style:Te.Dark}).catch(console.error),tt.setBackgroundColor({color:"#131722"}).catch(console.error)),navigator.vibrate&&navigator.vibrate([200,100,200])}let v,Fe=!1;wt&&wt.addEventListener("click",()=>{he.classList.remove("hidden"),w&&w.classList.add("hidden"),setTimeout(Yt,10)});function Yt(){const e=he.querySelector(".drawing-area");if(!e)return;const t=e.clientWidth,n=e.clientHeight;h.width=t,h.height=n,v=h.getContext("2d"),v.lineCap="round",v.lineJoin="round",v.lineWidth=3,v.strokeStyle="#000000",te.forEach(s=>s.classList.remove("active")),te[0]&&te[0].classList.add("active")}h.addEventListener("mousedown",ws);h.addEventListener("mouseup",Jt);h.addEventListener("mousemove",Qt);h.addEventListener("mouseleave",Jt);h.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY});h.dispatchEvent(n)},{passive:!1});h.addEventListener("touchend",e=>{e.preventDefault();const t=new MouseEvent("mouseup",{});h.dispatchEvent(t)},{passive:!1});h.addEventListener("touchmove",e=>{e.preventDefault();const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY});h.dispatchEvent(n)},{passive:!1});function ws(e){Fe=!0,Qt(e)}function Jt(){Fe=!1,v&&v.beginPath()}function Qt(e){if(!Fe||!v)return;const t=h.getBoundingClientRect(),n=e.clientX-t.left,s=e.clientY-t.top;v.lineTo(n,s),v.stroke(),v.beginPath(),v.moveTo(n,s)}Bt&&Bt.addEventListener("click",()=>{v&&v.clearRect(0,0,h.width,h.height)});It&&It.addEventListener("click",()=>{he.classList.add("hidden")});te.forEach(e=>{e.addEventListener("click",t=>{te.forEach(s=>s.classList.remove("active")),t.target.classList.add("active");const n=t.target.getAttribute("data-color");v&&(v.strokeStyle=n)})});St&&St.addEventListener("click",async()=>{console.log("Send Drawing Clicked - Start");try{const e=h.toDataURL("image/png");console.log("Canvas to DataURL success, length:",e.length),ve(e),console.log("sendImageMessage called")}catch(e){console.error("Critical Error sending drawing:",e)}finally{console.log("Entering Finally Block - Forcing Close");const e=document.getElementById("drawing-modal");e?(e.classList.add("hidden"),e.style.display="none",setTimeout(()=>{e.style.display=""},500),console.log("Modal Closed via Class + Style")):console.error("FATAL: Modal element not found in DOM during close"),v&&(v.clearRect(0,0,h.width,h.height),console.log("Canvas Cleared"))}});window.addEventListener("resize",()=>{he.classList.contains("hidden")||Yt()});function Es(){q.isNativePlatform(),"getBattery"in navigator&&navigator.getBattery().then(e=>{ke(e),e.addEventListener("levelchange",()=>ke(e)),e.addEventListener("chargingchange",()=>ke(e))})}let Pt=-1,kt=null;function ke(e){console.log("Battery Update Triggered",e.level,e.charging);const t=e.level*100,n=e.charging;(Math.abs(t-Pt)>=1||n!==kt)&&(Pt=t,kt=n,console.log("Pushing Battery Update to DB:",t,n),f.ref(`status/${g}/battery`).set({level:t,isCharging:n,timestamp:firebase.database.ServerValue.TIMESTAMP}).catch(s=>console.error("Battery DB Error",s)))}const bs=40;let Tt=0;async function Is(){try{await Sn.addListener("accel",e=>{const{x:t,y:n,z:s}=e.acceleration;if(t===null)return;const o=Math.abs(t)+Math.abs(n)+Math.abs(s);if(o>bs){const i=Date.now();i-Tt>1e3&&(console.log("Violent Shake Detected! Magnitude:",o),Tt=i,ue.classList.contains("hidden")||Ne())}}),console.log("Shake detection armed.")}catch(e){console.error("Shake Support Error:",e)}}Is();Es();function Zt(e,t){const n=document.getElementById(`status-${e}`);n&&(t?n.classList.add("seen"):n.classList.remove("seen"))}function xt(e=80){const{scrollTop:t,scrollHeight:n,clientHeight:s}=B;return n-t-s<=e}function Dt(e=!0){e?B.scrollTo({top:B.scrollHeight,behavior:"smooth"}):B.scrollTop=B.scrollHeight}function Ss(){const e=Array.from(B.querySelectorAll(".message"));e.forEach((t,n)=>{t.classList.remove("group-start","group-mid","group-end");const s=e[n-1],o=e[n+1],i=t.classList.contains("outgoing"),a=s&&s.classList.contains(i?"outgoing":"incoming"),r=o&&o.classList.contains(i?"outgoing":"incoming");a||t.classList.add("group-start"),r||t.classList.add("group-end"),a&&r&&t.classList.add("group-mid")})}function le(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Bs(e,t,n){let s=0,o=0;e.addEventListener("touchstart",i=>{s=i.touches[0].clientX,o=s,e.classList.add("swiping")},{passive:!0}),e.addEventListener("touchmove",i=>{o=i.touches[0].clientX;const a=o-s,r=Math.max(0,Math.min(a,120));e.style.transform=`translate3d(${r}px, 0, 0)`},{passive:!0}),e.addEventListener("touchend",()=>{const i=o-s;e.classList.remove("swiping"),i>50&&en(t,n),e.style.transform="translate3d(0, 0, 0)",s=0,o=0})}function en(e,t){z={id:t,text:e.image?"üì∑ Photo":e.text,sender:e.sender},On.textContent=e.sender===g?"You":e.sender,Un.textContent=z.text,Re.classList.remove("hidden"),U.focus()}function Mt(e){f.ref(`messages/${e}`).update({deleted:!0,text:"üö´ This message was deleted",image:null,file:null}).then(()=>{console.log("Message deleted successfully.")}).catch(t=>{console.error("Error deleting message:",t)})}function tn(){z=null,Re.classList.add("hidden")}function nn(){se.classList.add("hidden"),confirm("Are you sure you want to clear this chat? It will be deleted for both sides.")&&f.ref("messages").remove().then(()=>{B.innerHTML=""}).catch(e=>{console.error("Remove failed: "+e.message),alert("Failed to clear chat: "+e.message)})}function ze(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("Camera not supported or permission denied.");return}_e.classList.remove("hidden"),Ve()}function Ve(){C&&C.stop();const e={video:{facingMode:ne},audio:!1};navigator.mediaDevices.getUserMedia(e).then(function(t){O.srcObject=t,C=t.getTracks()[0]}).catch(function(t){console.error("Camera Error: "+t),alert("Could not access camera: "+t.message),ne==="environment"?(ne="user",Ve()):_e.classList.add("hidden")})}function sn(){ne=ne==="user"?"environment":"user",Ve()}function on(){_e.classList.add("hidden"),C&&(C.stop(),C=null),O.srcObject=null}function an(){if(!C)return;W.width=O.videoWidth,W.height=O.videoHeight,W.getContext("2d").drawImage(O,0,0,W.width,W.height);const t=W.toDataURL("image/jpeg",.8);Y.src=t,O.classList.add("hidden"),Y.classList.remove("hidden"),Ut.classList.add("hidden"),Rt.classList.remove("hidden")}function pe(){Y.classList.add("hidden"),O.classList.remove("hidden"),Rt.classList.add("hidden"),Ut.classList.remove("hidden"),Y.src=""}function Cs(){console.log("confirmSendPhoto called");const e=Y.src;try{e?(ve(e),console.log("Photo sent via sendImageMessage")):console.warn("confirmSendPhoto: No dataUrl found")}catch(t){console.error("Error sending photo:",t)}finally{console.log("confirmSendPhoto: Forcing close"),on();const t=document.getElementById("camera-modal");t&&(t.classList.add("hidden"),t.style.display="none",setTimeout(()=>t.style.display="",500)),setTimeout(pe,300)}}window.handleLogin=Ft;window.handleTyping=Vt;window.handleImageSelect=Gt;window.handleClearChat=nn;window.sendMessage=He;window.capturePhoto=an;window.openCamera=ze;window.closeCameraModal=function(){const e=document.getElementById("camera-modal");e.classList.add("hidden"),e.style.display="none",C&&(C.stop(),C=null),O.srcObject=null,setTimeout(()=>{e.style.display=""},500)};window.viewSecretPhoto=(e,t)=>{const n=document.getElementById("image-modal"),s=document.getElementById("modal-img");if(!n||!s)return;s.src=t,s.src=t,n.classList.remove("hidden"),n.style.display="flex";let o=document.getElementById("secret-timer-overlay");o||(o=document.createElement("div"),o.id="secret-timer-overlay",o.style.cssText=`
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.7); color: #ff5252; 
            font-size: 24px; font-weight: bold; 
            padding: 10px 20px; border-radius: 30px;
            pointer-events: none; z-index: 1010;
        `,n.appendChild(o));let i=10;o.textContent=`üî• ${i}s`;const a=setInterval(()=>{i--,o.textContent=`üî• ${i}s`,i<=0&&(clearInterval(a),n.classList.add("hidden"),o.remove(),s.src="",console.log("Self-destructing message:",e),f.ref("messages/"+e).remove())},1e3),r=()=>{clearInterval(a),f.ref("messages/"+e).remove(),o&&o.remove(),n.removeEventListener("click",r)};n.onclick=d=>{(d.target===n||d.target.id==="close-modal")&&(r(),n.classList.add("hidden"))}};window.retakePhoto=pe;window.switchCamera=sn;window.confirmSendPhoto=function(){window.closeCameraModal();const e=Y.src;e&&ve(e),setTimeout(pe,300)};window.imageInput=ae;function Ps(e,t){f.ref(`messages/${e}/reactions/${g}`).transaction(s=>s?null:"‚ù§Ô∏è")}function ks(e,t){const n=document.getElementById(`reactions-${e}`);if(n)if(t){const s=Object.keys(t).length;n.textContent="‚ù§Ô∏è"+(s>1?" "+s:""),n.classList.remove("hidden")}else n.textContent="",n.classList.add("hidden")}export{Oe as W,F as _,x as r};
