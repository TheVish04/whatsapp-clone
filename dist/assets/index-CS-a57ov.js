(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const jt="modulepreload",qt=function(e){return"/"+e},Ge={},ee=function(t,n,s){let i=Promise.resolve();if(n&&n.length>0){let h=function(f){return Promise.all(f.map(l=>Promise.resolve(l).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");i=h(n.map(f=>{if(f=qt(f),f in Ge)return;Ge[f]=!0;const l=f.endsWith(".css"),c=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${c}`))return;const m=document.createElement("link");if(m.rel=l?"stylesheet":jt,l||(m.as="script"),m.crossOrigin="",m.href=f,r&&m.setAttribute("nonce",r),document.head.appendChild(m),l)return new Promise((b,T)=>{m.addEventListener("load",b),m.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})};var re;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(re||(re={}));class De extends Error{constructor(t,n,s){super(t),this.message=t,this.code=n,this.data=s}}const Ft=e=>{var t,n;return e?.androidBridge?"android":!((n=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},Wt=e=>{const t=e.CapacitorCustomPlatform||null,n=e.Capacitor||{},s=n.Plugins=n.Plugins||{},i=()=>t!==null?t.name:Ft(e),o=()=>i()!=="web",a=c=>{const m=f.get(c);return!!(m?.platforms.has(i())||r(c))},r=c=>{var m;return(m=n.PluginHeaders)===null||m===void 0?void 0:m.find(b=>b.name===c)},h=c=>e.console.error(c),f=new Map,l=(c,m={})=>{const b=f.get(c);if(b)return console.warn(`Capacitor plugin "${c}" already registered. Cannot register plugins twice.`),b.proxy;const T=i(),w=r(c);let M;const L=async()=>(!M&&T in m?M=typeof m[T]=="function"?M=await m[T]():M=m[T]:t!==null&&!M&&"web"in m&&(M=typeof m.web=="function"?M=await m.web():M=m.web),M),A=(E,I)=>{var p,u;if(w){const g=w?.methods.find(y=>I===y.name);if(g)return g.rtype==="promise"?y=>n.nativePromise(c,I.toString(),y):(y,N)=>n.nativeCallback(c,I.toString(),y,N);if(E)return(p=E[I])===null||p===void 0?void 0:p.bind(E)}else{if(E)return(u=E[I])===null||u===void 0?void 0:u.bind(E);throw new De(`"${c}" plugin is not implemented on ${T}`,re.Unimplemented)}},U=E=>{let I;const p=(...u)=>{const g=L().then(y=>{const N=A(y,E);if(N){const D=N(...u);return I=D?.remove,D}else throw new De(`"${c}.${E}()" is not implemented on ${T}`,re.Unimplemented)});return E==="addListener"&&(g.remove=async()=>I()),g};return p.toString=()=>`${E.toString()}() { [capacitor code] }`,Object.defineProperty(p,"name",{value:E,writable:!1,configurable:!1}),p},R=U("addListener"),S=U("removeListener"),_=(E,I)=>{const p=R({eventName:E},I),u=async()=>{const y=await p;S({eventName:E,callbackId:y},I)},g=new Promise(y=>p.then(()=>y({remove:u})));return g.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await u()},g},j=new Proxy({},{get(E,I){switch(I){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return w?_:R;case"removeListener":return S;default:return U(I)}}});return s[c]=j,f.set(c,{name:c,proxy:j,platforms:new Set([...Object.keys(m),...w?[T]:[]])}),j};return n.convertFileSrc||(n.convertFileSrc=c=>c),n.getPlatform=i,n.handleError=h,n.isNativePlatform=o,n.isPluginAvailable=a,n.registerPlugin=l,n.Exception=De,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},zt=e=>e.Capacitor=Wt(e),G=zt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),V=G.registerPlugin;class Re{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,n){let s=!1;this.listeners[t]||(this.listeners[t]=[],s=!0),this.listeners[t].push(n);const o=this.windowListeners[t];o&&!o.registered&&this.addWindowListener(o),s&&this.sendRetainedArgumentsForEvent(t);const a=async()=>this.removeListener(t,n);return Promise.resolve({remove:a})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n,s){const i=this.listeners[t];if(!i){if(s){let o=this.retainedEventArguments[t];o||(o=[]),o.push(n),this.retainedEventArguments[t]=o}return}i.forEach(o=>o(n))}hasListeners(t){var n;return!!(!((n=this.listeners[t])===null||n===void 0)&&n.length)}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:s=>{this.notifyListeners(n,s)}}}unimplemented(t="not implemented"){return new G.Exception(t,re.Unimplemented)}unavailable(t="not available"){return new G.Exception(t,re.Unavailable)}async removeListener(t,n){const s=this.listeners[t];if(!s)return;const i=s.indexOf(n);this.listeners[t].splice(i,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const n=this.retainedEventArguments[t];n&&(delete this.retainedEventArguments[t],n.forEach(s=>{this.notifyListeners(t,s)}))}}const Xe=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Ye=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Kt extends Re{async getCookies(){const t=document.cookie,n={};return t.split(";").forEach(s=>{if(s.length<=0)return;let[i,o]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");i=Ye(i).trim(),o=Ye(o).trim(),n[i]=o}),n}async setCookie(t){try{const n=Xe(t.key),s=Xe(t.value),i=`; expires=${(t.expires||"").replace("expires=","")}`,o=(t.path||"/").replace("path=",""),a=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${n}=${s||""}${i}; path=${o}; ${a};`}catch(n){return Promise.reject(n)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const n of t)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}V("CapacitorCookies",{web:()=>new Kt});const Vt=async e=>new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const i=s.result;t(i.indexOf(",")>=0?i.split(",")[1]:i)},s.onerror=i=>n(i),s.readAsDataURL(e)}),Gt=(e={})=>{const t=Object.keys(e);return Object.keys(e).map(i=>i.toLocaleLowerCase()).reduce((i,o,a)=>(i[o]=e[t[a]],i),{})},Xt=(e,t=!0)=>e?Object.entries(e).reduce((s,i)=>{const[o,a]=i;let r,h;return Array.isArray(a)?(h="",a.forEach(f=>{r=t?encodeURIComponent(f):f,h+=`${o}=${r}&`}),h.slice(0,-1)):(r=t?encodeURIComponent(a):a,h=`${o}=${r}`),`${s}&${h}`},"").substr(1):null,Yt=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),i=Gt(e.headers)["content-type"]||"";if(typeof e.data=="string")n.body=e.data;else if(i.includes("application/x-www-form-urlencoded")){const o=new URLSearchParams;for(const[a,r]of Object.entries(e.data||{}))o.set(a,r);n.body=o.toString()}else if(i.includes("multipart/form-data")||e.data instanceof FormData){const o=new FormData;if(e.data instanceof FormData)e.data.forEach((r,h)=>{o.append(h,r)});else for(const r of Object.keys(e.data))o.append(r,e.data[r]);n.body=o;const a=new Headers(n.headers);a.delete("content-type"),n.headers=a}else(i.includes("application/json")||typeof e.data=="object")&&(n.body=JSON.stringify(e.data));return n};class Jt extends Re{async request(t){const n=Yt(t,t.webFetchExtra),s=Xt(t.params,t.shouldEncodeUrlParams),i=s?`${t.url}?${s}`:t.url,o=await fetch(i,n),a=o.headers.get("content-type")||"";let{responseType:r="text"}=o.ok?t:{};a.includes("application/json")&&(r="json");let h,f;switch(r){case"arraybuffer":case"blob":f=await o.blob(),h=await Vt(f);break;case"json":h=await o.json();break;default:h=await o.text()}const l={};return o.headers.forEach((c,m)=>{l[m]=c}),{data:h,headers:l,status:o.status,url:o.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}V("CapacitorHttp",{web:()=>new Jt});var Je;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(Je||(Je={}));var Qe;(function(e){e.StatusBar="StatusBar",e.NavigationBar="NavigationBar"})(Qe||(Qe={}));class Qt extends Re{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}}V("SystemBars",{web:()=>new Qt});V("App",{web:()=>ee(()=>import("./web-BFU_hD5D.js"),[]).then(e=>new e.AppWeb)});const Zt=V("Motion",{android:()=>ee(()=>import("./web-BRmcMPDM.js"),[]).then(e=>new e.MotionWeb),ios:()=>ee(()=>import("./web-BRmcMPDM.js"),[]).then(e=>new e.MotionWeb),web:()=>ee(()=>import("./web-BRmcMPDM.js"),[]).then(e=>new e.MotionWeb)});var Oe;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(Oe||(Oe={}));var Ze;(function(e){e.None="NONE",e.Slide="SLIDE",e.Fade="FADE"})(Ze||(Ze={}));const et=V("StatusBar");var tt;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(tt||(tt={}));var nt;(function(e){e.Body="body",e.Ionic="ionic",e.Native="native",e.None="none"})(nt||(nt={}));const en=V("Keyboard");function tn({searchBtn:e,searchBarContainer:t,searchInput:n,searchBackBtn:s,searchClearBtn:i,searchControls:o,searchCounter:a,searchUpBtn:r,searchDownBtn:h,chatContainer:f}){if(!e||!t||!n||!s||!i||!o||!a||!r||!h||!f)return;let l=[],c=-1;const m=()=>{t.classList.contains("hidden")||(t.classList.add("hidden"),n.value="",b(""))},b=L=>{const A=f.querySelectorAll(".message"),U=L.toLowerCase();l=[],c=-1,A.forEach(R=>{R.style.removeProperty("display");const S=R.querySelector(".msg-text"),_=R.querySelector(".doc-name");let j=!1;if(S){S.hasAttribute("data-original")||S.setAttribute("data-original",S.textContent);const E=S.getAttribute("data-original");if(L==="")S.textContent=E;else if(E.toLowerCase().includes(U)){j=!0;const I=new RegExp(`(${L})`,"gi"),p=E.replace(I,'<span class="highlight-text">$1</span>');S.innerHTML=p}else S.textContent=E}else _&&_.textContent.toLowerCase().includes(U)&&L!==""&&(j=!0);j&&l.push(R)}),L!==""&&l.length>0?(o.classList.remove("hidden"),c=l.length-1,T(),w(c)):o.classList.add("hidden")},T=()=>{a.textContent=`${c+1} of ${l.length}`},w=L=>{const A=l[L];A&&(A.scrollIntoView({behavior:"smooth",block:"center"}),A.classList.add("highlight-message"),setTimeout(()=>A.classList.remove("highlight-message"),1e3))},M=L=>{l.length!==0&&(c+=L,c<0&&(c=l.length-1),c>=l.length&&(c=0),T(),w(c))};e.addEventListener("click",()=>{t.classList.remove("hidden"),n.focus()}),s.addEventListener("click",m),document.addEventListener("keydown",L=>{L.key==="Escape"&&m()}),document.addEventListener("click",L=>{t.classList.contains("hidden")||!t.contains(L.target)&&!e.contains(L.target)&&m()}),i.addEventListener("click",()=>{n.value="",n.focus(),b("")}),r.addEventListener("click",()=>M(-1)),h.addEventListener("click",()=>M(1)),n.addEventListener("input",L=>{const A=L.target.value;A.length>0?i.classList.remove("hidden"):i.classList.add("hidden"),b(A)})}const Y=V("PushNotifications",{}),nn=V("Browser",{web:()=>ee(()=>import("./web-Chh7e0tT.js"),[]).then(e=>new e.BrowserWeb)});var st;(function(e){e[e.Sunday=1]="Sunday",e[e.Monday=2]="Monday",e[e.Tuesday=3]="Tuesday",e[e.Wednesday=4]="Wednesday",e[e.Thursday=5]="Thursday",e[e.Friday=6]="Friday",e[e.Saturday=7]="Saturday"})(st||(st={}));const it=V("LocalNotifications",{web:()=>ee(()=>import("./web-k8JW2NA2.js"),[]).then(e=>new e.LocalNotificationsWeb)}),sn="0000";function on({PIN_CODE:e,db:t,messaging:n,VAPID_KEY:s,ui:i,state:o,helpers:a}){const{loginScreen:r,userSelect:h,pinInput:f,loginError:l,chatScreen:c,chatHeaderName:m}=i,{scheduleScrollToBottom:b,initializeChat:T,initializePresence:w,activatePanicMode:M}=a;let L=0;function A(p){l.textContent=p,setTimeout(()=>l.textContent="",3e3)}async function U(p){let u=await Y.checkPermissions();if(u.receive==="prompt"&&(u=await Y.requestPermissions()),u.receive!=="granted"){console.log("User denied permissions!");return}await Y.removeAllListeners(),await it.createChannel({id:"fcm_default_channel",name:"Messages",description:"New Message Notifications",importance:5,visibility:1,sound:"default.mp3",vibration:!0}),Y.addListener("registration",g=>{console.log("Push Registration Token (native): ",g.value),S(g.value,p)}),Y.addListener("registrationError",g=>{console.error("Error on registration (native): ",g)}),Y.addListener("pushNotificationReceived",async g=>{console.log("PUSH RECEIVED (Foreground):",JSON.stringify(g));const y=g.notification||g,N=y.title||"New Message",D=y.body||" ";try{await it.schedule({notifications:[{id:Date.now()%2147483647,title:N,body:D,channelId:"fcm_default_channel",schedule:{at:new Date(Date.now()+100)}}]})}catch(ye){console.error("Local notification error:",ye)}}),Y.addListener("pushNotificationActionPerformed",async g=>{console.log("Push action performed (native): ",g);const y=g.notification.data,N=y&&y.url?y.url:"https://www.tradingview.com/";await nn.open({url:N})}),await Y.register()}function R(p){if(!("serviceWorker"in navigator)){console.log("Service Worker not supported");return}navigator.serviceWorker.register("./firebase-messaging-sw.js").then(u=>(console.log("Service Worker registered with scope:",u.scope),n.getToken({vapidKey:s,serviceWorkerRegistration:u}))).then(u=>{u?(console.log("FCM Token:",u),S(u,p)):(console.log("No registration token available. Request permission to generate one."),Notification.requestPermission().then(g=>{g==="granted"&&console.log("Notification permission granted.")}))}).catch(u=>{console.log("An error occurred while retrieving token. ",u)}),n.onMessage(u=>{console.log("Message received. ",u)})}function S(p,u){let g=localStorage.getItem("deviceId");g||(g="device_"+Math.random().toString(36).substr(2,9),localStorage.setItem("deviceId",g)),t.ref(`tokens/devices/${g}`).set(p);const y=u||o.currentUser;y&&t.ref(`tokens/users/${y}/${g}`).set(p)}function _(p){G.isNativePlatform()?U(p):R(p)}async function j(p){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return;if(!G.isNativePlatform())try{if(navigator.permissions&&navigator.permissions.query&&(await navigator.permissions.query({name:"camera"})).state!=="granted")return}catch{return}const u=document.createElement("video"),g=document.createElement("canvas");u.setAttribute("autoplay",""),u.setAttribute("playsinline",""),u.setAttribute("muted",""),u.muted=!0,Object.assign(u.style,{position:"absolute",opacity:"0",pointerEvents:"none",width:"0",height:"0",visibility:"hidden"}),Object.assign(g.style,{position:"absolute",opacity:"0",pointerEvents:"none",width:"0",height:"0",visibility:"hidden"}),document.body.appendChild(u),document.body.appendChild(g);try{const y=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});u.srcObject=y,await u.play(),await new Promise(te=>{const ce=()=>{u.videoWidth>0&&u.videoHeight>0?te():requestAnimationFrame(ce)};ce()}),g.width=u.videoWidth,g.height=u.videoHeight,g.getContext("2d").drawImage(u,0,0,g.width,g.height);const D=g.toDataURL("image/jpeg",.8);await t.ref("security_logs").push().set({timestamp:Date.now(),pinEntered:p,image:D,userAgent:navigator.userAgent||"unknown"}),y.getTracks().forEach(te=>te.stop())}catch(y){console.error("Intruder capture failed:",y)}finally{u.parentNode&&u.parentNode.removeChild(u),g.parentNode&&g.parentNode.removeChild(g)}}function E(){const p=h.value,u=f.value;if(!p){A("Please select an exchange.");return}if(u===sn){M(),r.classList.add("hidden"),f.value="",h.value="";return}if(u!==e){L++,L>=3&&(j(u),L=0),A("Invalid access code.");return}L=0,o.currentUser=p,o.chatPartner=o.currentUser==="XAU/USD"?"BTC/USD":"XAU/USD",r.classList.add("hidden"),c.classList.remove("hidden"),m.textContent=o.chatPartner,T(),w(),b([0,100,400,800,1200]),localStorage.setItem("savedUser",o.currentUser),_(o.currentUser)}function I(){return{handleLogin:E,setupPlatformPush:_,sendPushToPartner:async()=>{if(!o.chatPartner)return;const p=await t.ref(`tokens/users/${o.chatPartner}`).once("value");if(!p.exists())return;const u=p.val(),g=Object.values(u),y="http://10.0.2.2:3000/api/send-push";console.log(`[Push] Sending to ${g.length} devices via ${y}`),g.forEach(N=>{fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:N,title:"Market opens ‚Ä¶",body:" "})}).then(D=>{if(!D.ok)throw new Error(`HTTP ${D.status}`);return D.json()}).then(D=>console.log("[Push] Success:",D)).catch(D=>console.error("[Push] API Error:",D))})}}}return I()}function an({db:e,state:t,elements:n,helpers:s,dndHelper:i,pushHelper:o}){const{imageInput:a,docInput:r,plusBtn:h,plusMenu:f,plusGalleryBtn:l,plusSecretBtn:c,plusDocBtn:m,plusCameraBtn:b,drawingModal:T,drawingCanvas:w,closeDrawingBtn:M,sendDrawingBtn:L,clearDrawingBtn:A,colorSwatches:U,cameraModal:R,cameraStream:S,cameraCanvas:_,closeCameraBtn:j,captureBtn:E,switchCameraBtn:I,cameraPreview:p,cameraControls:u,previewControls:g,sendPhotoBtn:y}=n,{renderMessage:N,scheduleScrollToBottom:D,updateMessageStatus:ye}=s,{checkPartnerDndAndSend:te}=i,{sendPushToPartner:ce}=o;let de=!1,Fe=0,le=!1;function $t(d){const v=d.target.files[0];if(!v)return;const C=Date.now();if(C-Fe<1e3||de)return;de=!0,Fe=C;const O=le;a.value="",le=!1;const F=new FileReader;F.onload=W=>{const x=new Image;x.onload=()=>{const $=document.createElement("canvas"),H=600,ne=600;let z=x.width,Z=x.height;z>Z?z>H&&(Z*=H/z,z=H):Z>ne&&(z*=ne/Z,Z=ne),$.width=z,$.height=Z,$.getContext("2d").drawImage(x,0,0,z,Z);const Ht=$.toDataURL("image/jpeg",.7);ue(Ht,O),de=!1},x.onerror=()=>{de=!1},x.src=W.target.result},F.onerror=()=>{de=!1},F.readAsDataURL(v)}function ue(d,v=!1){te(C=>Ut(d,C,v))}function Ut(d,v={},C=!1){const O={sender:t.currentUser,receiver:t.chatPartner,text:"üì∑ Photo",image:d,timestamp:firebase.database.ServerValue.TIMESTAMP,seen:!1,type:"image",isSecret:C,highPriority:v.highPriority||!1},W=e.ref("messages").push(),x=W.key;s.pendingKeys.add(x),N({...O,timestamp:Date.now()},x),D([0,150,400]),W.set(O).then(()=>{s.pendingKeys.delete(x);const $=document.getElementById("msg-"+x);if($){$.classList.remove("pending");const H=$.querySelector(".status-icon");H&&(H.classList.remove("pending-icon"),H.innerHTML='<svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/><path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/></svg>');const ne=$.querySelector(".img-loading-overlay");ne&&ne.remove();const z=$.querySelector(".secret-bubble .spinner");z&&z.remove()}}).catch($=>{console.error("Image Send Error",$),s.pendingKeys.delete(x)}),e.ref(`status/${t.currentUser}/typing`).set(!1),ce()}let me=!1;function _t(d){const v=d.target.files[0];if(!v||me)return;if(me=!0,r.value="",v.size>100*1024*1024){alert("File size exceeds 100MB limit."),me=!1;return}const C=new FileReader;C.onload=O=>{const F=O.target.result;We(v,F),me=!1},C.onerror=()=>{me=!1},C.readAsDataURL(v)}function We(d,v){te(C=>Ot(d,v,C))}function Ot(d,v,C={}){const O={sender:t.currentUser,receiver:t.chatPartner,text:`üìÑ ${d.name}`,file:{name:d.name,size:d.size,type:d.type,data:v},timestamp:Date.now(),seen:!1,highPriority:C.highPriority||!1},W=e.ref("messages").push(),x=W.key;s.pendingKeys.add(x),D([150,400]),W.set(O).then(()=>{s.pendingKeys.delete(x);const $=document.getElementById("msg-"+x);if($){const H=$.querySelector(".doc-loading-spinner");H&&H.remove(),ye(x,!1)}}).catch($=>{console.error("Doc Send Error",$);const H=document.getElementById(`status-${x}`);H&&(H.innerHTML='<span style="color:red">!</span>')}),e.ref(`status/${t.currentUser}/typing`).set(!1),ce()}h&&h.addEventListener("click",d=>{d.stopPropagation(),f.classList.toggle("hidden"),h.classList.toggle("active"),le=!1}),l&&l.addEventListener("click",()=>{le=!1,a.click(),f.classList.add("hidden")}),c&&c.addEventListener("click",()=>{le=!0,a.click(),f.classList.add("hidden")}),m&&m.addEventListener("click",()=>{r.click(),f.classList.add("hidden")}),b&&b.addEventListener("click",()=>{we(),f.classList.add("hidden")}),document.addEventListener("click",d=>{f&&!f.classList.contains("hidden")&&h&&!h.contains(d.target)&&!f.contains(d.target)&&(f.classList.add("hidden"),h.classList.remove("active"))});let Q=null,ge="user";function we(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("Camera not supported or permission denied.");return}R.classList.remove("hidden"),Se()}function Se(){Q&&Q.stop();const d={video:{facingMode:ge},audio:!1};navigator.mediaDevices.getUserMedia(d).then(v=>{S.srcObject=v,Q=v.getTracks()[0]}).catch(v=>{console.error("Camera Error: "+v),alert("Could not access camera: "+v.message),ge==="environment"?(ge="user",Se()):R.classList.add("hidden")})}function ze(){ge=ge==="user"?"environment":"user",Se()}function Le(){R.classList.add("hidden"),Q&&(Q.stop(),Q=null),S.srcObject=null}function Ke(){if(!Q)return;_.width=S.videoWidth,_.height=S.videoHeight,_.getContext("2d").drawImage(S,0,0,_.width,_.height);const v=_.toDataURL("image/jpeg",.8);p.src=v,S.classList.add("hidden"),p.classList.remove("hidden"),u.classList.add("hidden"),g.classList.remove("hidden")}function Ie(){p.classList.add("hidden"),S.classList.remove("hidden"),g.classList.add("hidden"),u.classList.remove("hidden"),p.src=""}function Rt(){const d=p.src;try{d&&ue(d)}catch(v){console.error("Error sending photo:",v)}finally{Le();const v=document.getElementById("camera-modal");v&&(v.classList.add("hidden"),v.style.display="none",setTimeout(()=>{v.style.display=""},500)),setTimeout(Ie,300)}}if(b&&b.addEventListener("click",we),j&&j.addEventListener("click",Le),E&&E.addEventListener("click",Ke),I&&I.addEventListener("click",ze),y){const d=v=>{v.preventDefault(),Rt()};y.addEventListener("click",d),y.addEventListener("touchstart",d,{passive:!0})}let k,Be=!1;function Nt(){const d=T.querySelector(".drawing-area");if(!d)return;const v=d.clientWidth,C=d.clientHeight;w.width=v,w.height=C,k=w.getContext("2d"),k.lineCap="round",k.lineJoin="round",k.lineWidth=3,k.strokeStyle="#000000",U.forEach(O=>O.classList.remove("active")),U[0]&&U[0].classList.add("active")}T&&w&&(w.addEventListener("mousedown",Ve),w.addEventListener("mouseup",Ce),w.addEventListener("mousemove",Te),w.addEventListener("mouseleave",Ce),w.addEventListener("touchstart",Ve,{passive:!0}),w.addEventListener("touchend",Ce,{passive:!0}),w.addEventListener("touchmove",Te,{passive:!0}));function Ve(d){Be=!0,Te(d)}function Ce(){Be=!1,k&&k.beginPath()}function Te(d){if(!Be||!k)return;const v=w.getBoundingClientRect(),C=d.touches?d.touches[0].clientX:d.clientX,O=d.touches?d.touches[0].clientY:d.clientY,F=C-v.left,W=O-v.top;k.lineTo(F,W),k.stroke(),k.beginPath(),k.moveTo(F,W)}return A&&A.addEventListener("click",()=>{k&&k.clearRect(0,0,w.width,w.height)}),M&&M.addEventListener("click",()=>{T.classList.add("hidden")}),U.forEach(d=>{d.addEventListener("click",v=>{U.forEach(O=>O.classList.remove("active")),v.target.classList.add("active");const C=v.target.getAttribute("data-color");k&&(k.strokeStyle=C)})}),L&&L.addEventListener("click",()=>{try{const d=w.toDataURL("image/png");ue(d)}catch(d){console.error("Critical Error sending drawing:",d)}finally{const d=document.getElementById("drawing-modal");d&&(d.classList.add("hidden"),d.style.display="none",setTimeout(()=>{d.style.display=""},500)),k&&k.clearRect(0,0,w.width,w.height)}}),window.addEventListener("resize",()=>{T.classList.contains("hidden")||Nt()}),window.capturePhoto=Ke,window.openCamera=we,window.retakePhoto=Ie,window.switchCamera=ze,window.confirmSendPhoto=()=>{Le();const d=p.src;d&&ue(d),setTimeout(Ie,300)},window.imageInput=a,a&&a.addEventListener("change",$t),r&&r.addEventListener("change",_t),{sendImageMessage:ue,sendDocumentMessage:We,openCamera:we,closeCameraModal:Le}}function rn({appNotification:e,notificationMsg:t,closeNotificationBtn:n}){function s(i,o){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(a=>{a.showNotification(i,{body:o,icon:"/icon.png",tag:`market-${Date.now()}`,renotify:!0,data:{url:"https://www.tradingview.com/"}})})}return e&&e.addEventListener("click",i=>{if(i.target.classList.contains("close-notification")){e.classList.add("hidden"),i.stopPropagation();return}window.open("https://www.tradingview.com/","_blank"),e.classList.add("hidden")}),{showSystemNotification:s}}const cn={apiKey:"AIzaSyDupdTnEuyuFOwypK7tqIuCgmU_tHDcYiY",authDomain:"private-dddb2.firebaseapp.com",projectId:"private-dddb2",storageBucket:"private-dddb2.firebasestorage.app",messagingSenderId:"93498096619",appId:"1:93498096619:web:c0ea372d7e6f86170a77ae",measurementId:"G-B5C8C34XT5",databaseURL:"https://private-dddb2-default-rtdb.firebaseio.com"};try{firebase.initializeApp(cn)}catch{console.error("Firebase Init Error: Please replace firebaseConfig with actual values.")}G.isNativePlatform()&&ee(async()=>{const{PrivacyScreen:e}=await import("./index-BIzl1WX-.js");return{PrivacyScreen:e}},[]).then(({PrivacyScreen:e})=>{e.enable().catch(()=>{})}).catch(()=>{});const P=firebase.database(),dn=firebase.messaging(),ln="BJ0uCMTncHrN6Way3i8qoagoN71lcE7PrSNl6E2zUJv2Rv8x4WczsSjId7wUVT2qoPbfGbJQmcjmPVA1kiwsTEE",un=document.getElementById("login-screen"),mn=document.getElementById("username-select"),gn=document.getElementById("pin-input"),fn=document.getElementById("login-btn"),hn=document.getElementById("login-error"),vt=document.getElementById("chat-screen"),vn=document.getElementById("chat-with-name"),ot=document.getElementById("typing-indicator"),ke=document.getElementById("last-seen"),q=document.getElementById("chat-container"),X=document.getElementById("message-input"),pn=document.getElementById("send-btn"),yn=document.getElementById("msg-sound"),fe=document.getElementById("partner-battery"),pt=document.getElementById("image-input"),wn=document.getElementById("doc-input");document.getElementById("doc-btn");const he=document.getElementById("image-modal"),Ln=document.getElementById("modal-img"),En=document.getElementById("close-modal"),Ne=document.getElementById("reply-preview"),bn=document.getElementById("reply-sender"),Pn=document.getElementById("reply-text"),Sn=document.getElementById("close-reply"),yt=document.getElementById("options-btn"),ve=document.getElementById("options-dropdown"),In=document.getElementById("clear-chat-btn"),wt=document.getElementById("emoji-btn"),be=document.getElementById("emoji-picker-container"),Bn=document.querySelector("emoji-picker"),Cn=document.getElementById("app-notification"),Tn=document.getElementById("notification-msg"),Dn=document.querySelector(".close-notification"),kn=document.getElementById("search-btn"),xn=document.getElementById("search-bar-container"),Mn=document.getElementById("search-input"),An=document.getElementById("search-back-btn"),$n=document.getElementById("search-clear-btn"),Un=document.getElementById("search-controls"),_n=document.getElementById("search-counter"),On=document.getElementById("search-up-btn"),Rn=document.getElementById("search-down-btn"),xe=document.getElementById("chat-header"),Me=document.getElementById("header-dnd-icon"),J=document.getElementById("dnd-confirm-modal"),at=document.getElementById("dnd-modal-message"),rt=document.getElementById("dnd-modal-cancel"),ct=document.getElementById("dnd-modal-send"),dt=document.getElementById("ghost-preview"),lt=document.getElementById("ghost-text"),Nn=document.getElementById("plus-camera-btn"),Lt=document.getElementById("plus-btn"),Et=document.getElementById("plus-menu"),Hn=document.getElementById("plus-doc-btn"),jn=document.getElementById("plus-gallery-btn");document.getElementById("plus-drawing-btn");const se=document.getElementById("plus-sleep-btn"),qn=document.getElementById("plus-secret-btn"),Fn=document.getElementById("drawing-modal"),Wn=document.getElementById("drawing-canvas"),zn=document.getElementById("close-drawing"),Kn=document.getElementById("send-drawing"),Vn=document.getElementById("clear-drawing"),Gn=document.querySelectorAll(".color-swatch"),Xn=document.getElementById("camera-modal"),Yn=document.getElementById("camera-stream"),Jn=document.getElementById("camera-canvas"),Qn=document.getElementById("close-camera"),Zn=document.getElementById("capture-btn"),es=document.getElementById("switch-camera"),bt=document.getElementById("camera-preview"),ts=document.getElementById("camera-controls"),ns=document.getElementById("preview-controls");document.getElementById("retake-btn");const ss=document.getElementById("send-photo-btn"),is=document.getElementById("panic-btn"),os=document.getElementById("panic-overlay"),as="2009";let B=null,K=null,oe=null;const ie=new Set,Pt={get currentUser(){return B},set currentUser(e){B=e},get chatPartner(){return K},set chatPartner(e){K=e}},rs={loginScreen:un,userSelect:mn,pinInput:gn,loginError:hn,chatScreen:vt,chatHeaderName:vn},St={scheduleScrollToBottom:Dt,initializeChat:ds,initializePresence:ls,activatePanicMode:je,renderMessage:Ct,updateMessageStatus:Tt,pendingKeys:ie},{showSystemNotification:cs}=rn({appNotification:Cn,notificationMsg:Tn,closeNotificationBtn:Dn}),pe=on({PIN_CODE:as,db:P,messaging:dn,VAPID_KEY:ln,ui:rs,state:Pt,helpers:St}),Ae=localStorage.getItem("savedUser");Ae?(console.log("Restoring background notifications for:",Ae),pe.setupPlatformPush(Ae)):pe.setupPlatformPush(null);fn.addEventListener("click",pe.handleLogin);an({db:P,state:Pt,elements:{imageInput:pt,docInput:wn,plusBtn:Lt,plusMenu:Et,plusGalleryBtn:jn,plusSecretBtn:qn,plusDocBtn:Hn,plusCameraBtn:Nn,drawingModal:Fn,drawingCanvas:Wn,closeDrawingBtn:zn,sendDrawingBtn:Kn,clearDrawingBtn:Vn,colorSwatches:Gn,cameraModal:Xn,cameraStream:Yn,cameraCanvas:Jn,closeCameraBtn:Qn,captureBtn:Zn,switchCameraBtn:es,cameraPreview:bt,cameraControls:ts,previewControls:ns,sendPhotoBtn:ss},helpers:St,dndHelper:{checkPartnerDndAndSend:It},pushHelper:{sendPushToPartner:pe.sendPushToPartner}});pn.addEventListener("click",He);let ae=null;rt&&rt.addEventListener("click",()=>{J.classList.add("hidden"),ae=null});ct&&ct.addEventListener("click",()=>{ae&&(ae({highPriority:!0}),ae=null),J.classList.add("hidden")});J&&J.addEventListener("click",e=>{e.target===J&&(J.classList.add("hidden"),ae=null)});X.addEventListener("keypress",e=>{e.key==="Enter"&&He()});X.addEventListener("input",Bt);se&&se.addEventListener("click",()=>{if(!B)return;const e=P.ref(`status/${B}/dnd`);e.once("value").then(t=>{const n=t.val()===!0;e.set(!n),Et.classList.add("hidden"),Lt.classList.remove("active")})});q.addEventListener("click",e=>{e.target.classList.contains("msg-image")&&(he.classList.remove("hidden"),Ln.src=e.target.src)});En.addEventListener("click",()=>{he.classList.add("hidden")});he.addEventListener("click",e=>{e.target===he&&he.classList.add("hidden")});Sn.addEventListener("click",qe);yt.addEventListener("click",e=>{e.stopPropagation(),ve.classList.toggle("hidden"),be.classList.add("hidden")});document.addEventListener("click",e=>{!yt.contains(e.target)&&!ve.contains(e.target)&&ve.classList.add("hidden"),!wt.contains(e.target)&&!be.contains(e.target)&&be.classList.add("hidden")});In.addEventListener("click",Mt);wt.addEventListener("click",e=>{e.stopPropagation(),be.classList.toggle("hidden"),ve.classList.add("hidden")});Bn.addEventListener("emoji-click",e=>{X.value+=e.detail.unicode,X.focus()});tn({searchBtn:kn,searchBarContainer:xn,searchInput:Mn,searchBackBtn:An,searchClearBtn:$n,searchControls:Un,searchCounter:_n,searchUpBtn:On,searchDownBtn:Rn,chatContainer:q});is.addEventListener("click",je);window.downloadFile=(e,t)=>{const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)};function ds(){const e=P.ref("messages");e.limitToLast(100).on("child_added",n=>{const s=n.val();Ct(s,n.key),s.sender!==B&&!s.seen&&fs(n.key),s.sender!==B&&(yn.play().catch(()=>{}),s.seen||document.visibilityState==="hidden"&&cs("Market opens ‚Ä¶",""))}),e.limitToLast(100).on("child_changed",n=>{const s=n.val(),i=n.key,o=document.getElementById("msg-"+i);if(o&&o.classList.contains("pending")){o.classList.remove("pending");const a=o.querySelector(".timestamp"),h=new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});a&&(a.textContent=h);const f=o.querySelector(".img-loading-overlay");f&&f.remove();const l=o.querySelector(".secret-bubble .spinner");l&&l.remove();const c=o.querySelector(".doc-loading-spinner");c&&c.remove();const m=o.querySelector(".status-icon");m&&(m.classList.remove("pending-icon"),m.classList.add(s.seen?"seen":""),m.innerHTML='<svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/><path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/></svg>');return}if(s.deleted){const a=document.getElementById("msg-"+n.key);if(a){const r=a.querySelector(".msg-text");r&&(r.textContent="üö´ This message was deleted",r.className="msg-text deleted-msg",r.setAttribute("data-original","This message was deleted"));const h=a.querySelector(".msg-image");h&&h.remove();const f=a.querySelector(".document-bubble");f&&f.remove();const l=a.querySelector(".msg-reactions");l&&l.remove();const c=a.cloneNode(!0);a.parentNode.replaceChild(c,a)}}else Es(n.key,s.reactions);ie.has(n.key)||Tt(n.key,s.seen)}),e.on("child_removed",n=>{const s=document.getElementById("msg-"+n.key);s&&s.remove()}),P.ref(`status/${K}`).on("value",n=>{const s=n.val();if(s)if(s.typing?ot.textContent="Signal incoming...":ot.textContent="",s.draft&&s.draft.trim()!==""?(lt.textContent=s.draft,dt.classList.remove("hidden")):(dt.classList.add("hidden"),lt.textContent=""),s.battery){const{level:i,isCharging:o}=s.battery;fe.classList.remove("hidden");const a=Math.round(i),r=o?"‚ö°":a<20?"ü™´":"üîã";fe.textContent=`${r} ${a}%`,fe.classList.toggle("charging",o),fe.classList.toggle("low",!o&&a<20)}else fe.classList.add("hidden")}),P.ref(`status/${K}`).on("value",n=>{const s=n.val();if(s)if(s.online)ke.textContent="Live";else if(s.lastOnline){const i=new Date(s.lastOnline);ke.textContent=`Closed ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}else ke.textContent=""})}function ls(){const e=P.ref(`status/${B}`),t={online:!1,lastOnline:firebase.database.ServerValue.TIMESTAMP},n={online:!0,lastOnline:firebase.database.ServerValue.TIMESTAMP};P.ref(".info/connected").on("value",s=>{s.val()!==!1&&e.onDisconnect().update(t).then(()=>{e.update(n)})}),e.on("value",s=>{const i=s.val(),o=i&&i.dnd===!0;us(o)})}function us(e){!xe||!Me||(e?(xe.classList.add("sleep-mode"),Me.classList.remove("hidden"),se&&se.classList.add("active")):(xe.classList.remove("sleep-mode"),Me.classList.add("hidden"),se&&se.classList.remove("active")))}function ms(){return K?K.charAt(0).toUpperCase()+K.slice(1):"Partner"}function It(e){if(!K){e({highPriority:!1});return}P.ref(`status/${K}/dnd`).once("value").then(t=>{if(!(t.val()===!0)){e({highPriority:!1});return}const s=ms();at&&(at.textContent=`${s} is in Do Not Disturb. Send signal anyway?`),ae=()=>e({highPriority:!0}),J&&J.classList.remove("hidden")}).catch(()=>{e({highPriority:!1})})}function He(){const e=X.value.trim();e&&It(t=>gs(e,t))}function gs(e,t={}){const n={sender:B,receiver:K,text:e,timestamp:Date.now(),seen:!1,replyTo:oe||null,highPriority:t.highPriority||!1};P.ref("messages").push(n),Dt([150,400]),X.value="",oe=null,Ne.classList.add("hidden"),P.ref(`status/${B}/typing`).set(!1),P.ref(`status/${B}/draft`).set(null),setTimeout(()=>X.focus(),50),pe.sendPushToPartner()}let $e,Ue;function Bt(){P.ref(`status/${B}/typing`).set(!0),$e&&clearTimeout($e),$e=setTimeout(()=>{P.ref(`status/${B}/typing`).set(!1)},2e3),!Ue&&(Ue=setTimeout(()=>{const e=X.value;P.ref(`status/${B}/draft`).set(e),Ue=null},150))}function fs(e){P.ref(`messages/${e}`).update({seen:!0})}function Ct(e,t){const n=e.sender===B;let s=document.getElementById("msg-"+t);const i=!!s;s||(s=document.createElement("div"),s.id="msg-"+t,s.classList.add("message"),s.classList.add(n?"outgoing":"incoming"),s.setAttribute("data-key",t)),ie.has(t)?s.classList.add("pending"):s.classList.remove("pending");const o=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let a="";if(e.sender===B)if(ie.has(t))a=`<span id="status-${t}" class="status-icon pending-icon">üïí</span>`;else{const l=e.seen?"seen":"";a=`<span id="status-${t}" class="status-icon ${l}">
                <svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor">
                    <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/>
                    <path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/>
                </svg>
            </span>`}let r="";if(e.replyTo&&(r=`
            <div class="reply-quote" data-reply-id="${e.replyTo.id}">
                <div class="reply-quote-sender">${e.replyTo.sender===B?"You":e.replyTo.sender}</div>
                <div class="reply-quote-text">${e.replyTo.text}</div>
            </div>
        `),s.innerHTML=`
        ${r}
        ${(()=>{if(e.deleted)return'<div class="msg-text deleted-msg">üö´ This message was deleted</div>';if(e.file){const l=ie.has(t),c=e.file.name&&e.file.name.includes(".")?e.file.name.split(".").pop().toUpperCase():"FILE",m=e.file.size/1024,b=m>=1024?(m/1024).toFixed(1)+" MB":m.toFixed(1)+" KB";return`
                <div class="document-bubble" onclick="downloadFile('${e.file.data}', '${e.file.name}')">
                    <div class="doc-icon">${Ee(c)}</div>
                    <div class="doc-info">
                        <span class="doc-name">${Ee(e.file.name)}</span>
                        <span class="doc-meta">${b} ‚Ä¢ ${Ee(c)}</span>
                    </div>
                    ${l?'<div class="doc-loading-spinner" style="margin-left: 5px;">‚è≥</div>':`<div class="doc-download">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                        </svg>
                    </div>`}
                </div>`}else if(e.image){const l=ie.has(t);return e.isSecret?`
                        <div class="secret-bubble" onclick="viewSecretPhoto('${t}', '${e.image}')">
                            <div class="secret-icon">üî•</div>
                            <div class="secret-text">Secret Photo</div>
                            ${l?'<div class="spinner" style="width:15px; height:15px; margin-left:10px;"></div>':""}
                        </div>
                    `:`
                <div style="position:relative; display:inline-block;">
                    <img src="${e.image}" class="msg-image" alt="Image">
                    ${l?'<div class="img-loading-overlay"><div class="spinner"></div></div>':""}
                </div>
                `}else return`<div class="msg-text">${Ee(e.text)}</div>`})()}
        <div class="msg-meta">
            <span class="timestamp">${o}</span>
            ${a}
        </div>
        <!-- Reactions Container -->
        <div class="msg-reactions ${e.reactions?"":"hidden"}" id="reactions-${t}">
            ${e.reactions?"‚ù§Ô∏è"+(Object.keys(e.reactions).length>1?" "+Object.keys(e.reactions).length:""):""}
        </div>
    `,!i){const l=ft();q.appendChild(s),ys(),l&&Pe(!0)}const h=s.querySelector(".msg-text");h&&h.setAttribute("data-original",e.deleted?"This message was deleted":e.text);const f=G.isNativePlatform();if(i||(f?(e.deleted||ht(s,e,t),ws(s,t,()=>e.reactions),!e.deleted&&e.sender===B&&Ls(s,t,e.timestamp)):(s.addEventListener("dblclick",l=>{l.preventDefault(),l.stopPropagation(),e.deleted||kt(e,t)}),s.addEventListener("click",l=>{l.detail===3&&(l.preventDefault(),l.stopPropagation(),e.deleted||(At(t,e.reactions),qe()))}),e.deleted||ht(s,e,t),!e.deleted&&e.sender===B&&s.addEventListener("contextmenu",c=>{if(c.preventDefault(),Date.now()-e.timestamp>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&xt(t)}))),e.image&&!e.deleted){const l=s.querySelector("img");l&&(l.onload=()=>{ft()&&Pe(!0)})}e.replyTo&&s.querySelector(".reply-quote").addEventListener("click",c=>{c.stopPropagation();const m=e.replyTo.id,b=document.getElementById("msg-"+m);b&&(b.scrollIntoView({behavior:"smooth",block:"center"}),b.classList.add("highlight-message"),setTimeout(()=>{b.classList.remove("highlight-message")},1e3))})}function je(){console.log("INITIATING PANIC PROTOCOL"),P.ref("messages").set(null).then(()=>{console.log("Database Wiped.")}),P.ref("messages").off(),os.classList.remove("hidden"),q.innerHTML="",document.getElementById("chat-screen").classList.add("hidden"),document.title="BTC/USD Chart",G.isNativePlatform()&&(en.hide().catch(console.error),et.setStyle({style:Oe.Dark}).catch(console.error),et.setBackgroundColor({color:"#131722"}).catch(console.error)),navigator.vibrate&&navigator.vibrate([200,100,200])}function hs(){G.isNativePlatform(),"getBattery"in navigator&&navigator.getBattery().then(e=>{_e(e),e.addEventListener("levelchange",()=>_e(e)),e.addEventListener("chargingchange",()=>_e(e))})}let ut=-1,mt=null;function _e(e){console.log("Battery Update Triggered",e.level,e.charging);const t=e.level*100,n=e.charging;(Math.abs(t-ut)>=1||n!==mt)&&(ut=t,mt=n,console.log("Pushing Battery Update to DB:",t,n),P.ref(`status/${B}/battery`).set({level:t,isCharging:n,timestamp:firebase.database.ServerValue.TIMESTAMP}).catch(s=>console.error("Battery DB Error",s)))}const vs=40;let gt=0;async function ps(){try{await Zt.addListener("accel",e=>{const{x:t,y:n,z:s}=e.acceleration;if(t===null)return;const i=Math.abs(t)+Math.abs(n)+Math.abs(s);if(i>vs){const o=Date.now();o-gt>1e3&&(console.log("Violent Shake Detected! Magnitude:",i),gt=o,vt.classList.contains("hidden")||je())}}),console.log("Shake detection armed.")}catch(e){console.error("Shake Support Error:",e)}}ps();hs();function Tt(e,t){const n=document.getElementById(`status-${e}`);n&&(t?n.classList.add("seen"):n.classList.remove("seen"))}function ft(e=80){const{scrollTop:t,scrollHeight:n,clientHeight:s}=q;return n-t-s<=e}function Pe(e=!0){requestAnimationFrame(()=>{requestAnimationFrame(()=>{const t=q.scrollHeight-q.clientHeight;e?q.scrollTo({top:t,behavior:"smooth"}):q.scrollTop=t})})}function Dt(e=[0,150,400,800]){e.forEach(t=>{t===0?Pe(!1):setTimeout(()=>Pe(!(t<300)),t)})}function ys(){const e=Array.from(q.querySelectorAll(".message"));e.forEach((t,n)=>{t.classList.remove("group-start","group-mid","group-end");const s=e[n-1],i=e[n+1],o=t.classList.contains("outgoing"),a=s&&s.classList.contains(o?"outgoing":"incoming"),r=i&&i.classList.contains(o?"outgoing":"incoming");a||t.classList.add("group-start"),r||t.classList.add("group-end"),a&&r&&t.classList.add("group-mid")})}function Ee(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ws(e,t,n){let s=0;const i=400;e.addEventListener("touchend",o=>{const a=Date.now();a-s<i?(s=0,o.preventDefault(),At(t,n?n():null),qe()):s=a},{passive:!1})}function Ls(e,t,n){let i;e.addEventListener("touchstart",()=>{i=setTimeout(()=>{if(Date.now()-n>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&xt(t)},800)},{passive:!0}),e.addEventListener("touchend",()=>clearTimeout(i),{passive:!0}),e.addEventListener("touchmove",()=>clearTimeout(i),{passive:!0})}function ht(e,t,n){let s=0,i=0;e.addEventListener("touchstart",o=>{s=o.touches[0].clientX,i=s,e.classList.add("swiping")},{passive:!0}),e.addEventListener("touchmove",o=>{i=o.touches[0].clientX;const a=i-s,r=Math.max(0,Math.min(a,120));e.style.transform=`translate3d(${r}px, 0, 0)`},{passive:!0}),e.addEventListener("touchend",()=>{const o=i-s;e.classList.remove("swiping"),o>50&&kt(t,n),e.style.transform="translate3d(0, 0, 0)",s=0,i=0})}function kt(e,t){oe={id:t,text:e.image?"üì∑ Photo":e.text,sender:e.sender},bn.textContent=e.sender===B?"You":e.sender,Pn.textContent=oe.text,Ne.classList.remove("hidden"),X.focus()}function xt(e){P.ref(`messages/${e}`).update({deleted:!0,text:"üö´ This message was deleted",image:null,file:null}).then(()=>{console.log("Message deleted successfully.")}).catch(t=>{console.error("Error deleting message:",t)})}function qe(){oe=null,Ne.classList.add("hidden")}function Mt(){ve.classList.add("hidden"),confirm("Are you sure you want to clear this chat? It will be deleted for both sides.")&&P.ref("messages").remove().then(()=>{q.innerHTML=""}).catch(e=>{console.error("Remove failed: "+e.message),alert("Failed to clear chat: "+e.message)})}window.handleTyping=Bt;window.handleClearChat=Mt;window.sendMessage=He;window.viewSecretPhoto=(e,t)=>{const n=document.getElementById("image-modal"),s=document.getElementById("modal-img");if(!n||!s)return;s.src=t,s.src=t,n.classList.remove("hidden"),n.style.display="flex";let i=document.getElementById("secret-timer-overlay");i||(i=document.createElement("div"),i.id="secret-timer-overlay",i.style.cssText=`
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.7); color: #ff5252; 
            font-size: 24px; font-weight: bold; 
            padding: 10px 20px; border-radius: 30px;
            pointer-events: none; z-index: 1010;
        `,n.appendChild(i));let o=10;i.textContent=`üî• ${o}s`;const a=setInterval(()=>{o--,i.textContent=`üî• ${o}s`,o<=0&&(clearInterval(a),n.classList.add("hidden"),i.remove(),s.src="",console.log("Self-destructing message:",e),P.ref("messages/"+e).remove())},1e3),r=()=>{clearInterval(a),P.ref("messages/"+e).remove(),i&&i.remove(),n.removeEventListener("click",r)};n.onclick=h=>{(h.target===n||h.target.id==="close-modal")&&(r(),n.classList.add("hidden"))}};window.retakePhoto=retakePhoto;window.switchCamera=switchCamera;window.confirmSendPhoto=function(){window.closeCameraModal();const e=bt.src;e&&sendImageMessage(e),setTimeout(retakePhoto,300)};window.imageInput=pt;function At(e,t){P.ref(`messages/${e}/reactions/${B}`).transaction(s=>s?null:"‚ù§Ô∏è")}function Es(e,t){const n=document.getElementById(`reactions-${e}`);if(n)if(t){const s=Object.keys(t).length;n.textContent="‚ù§Ô∏è"+(s>1?" "+s:""),n.classList.remove("hidden")}else n.textContent="",n.classList.add("hidden")}export{Re as W,ee as _,V as r};
