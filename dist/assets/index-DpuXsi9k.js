(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();var _;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(_||(_={}));class ae extends Error{constructor(t,n,s){super(t),this.message=t,this.code=n,this.data=s}}const Pt=e=>{var t,n;return e?.androidBridge?"android":!((n=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},Bt=e=>{const t=e.CapacitorCustomPlatform||null,n=e.Capacitor||{},s=n.Plugins=n.Plugins||{},o=()=>t!==null?t.name:Pt(e),i=()=>o()!=="web",a=l=>{const u=d.get(l);return!!(u?.platforms.has(o())||r(l))},r=l=>{var u;return(u=n.PluginHeaders)===null||u===void 0?void 0:u.find(O=>O.name===l)},c=l=>e.console.error(l),d=new Map,v=(l,u={})=>{const O=d.get(l);if(O)return console.warn(`Capacitor plugin "${l}" already registered. Cannot register plugins twice.`),O.proxy;const C=o(),R=r(l);let S;const kt=async()=>(!S&&C in u?S=typeof u[C]=="function"?S=await u[C]():S=u[C]:t!==null&&!S&&"web"in u&&(S=typeof u.web=="function"?S=await u.web():S=u.web),S),Ct=(p,y)=>{var L,T;if(R){const D=R?.methods.find(w=>y===w.name);if(D)return D.rtype==="promise"?w=>n.nativePromise(l,y.toString(),w):(w,Y)=>n.nativeCallback(l,y.toString(),w,Y);if(p)return(L=p[y])===null||L===void 0?void 0:L.bind(p)}else{if(p)return(T=p[y])===null||T===void 0?void 0:T.bind(p);throw new ae(`"${l}" plugin is not implemented on ${C}`,_.Unimplemented)}},oe=p=>{let y;const L=(...T)=>{const D=kt().then(w=>{const Y=Ct(w,p);if(Y){const J=Y(...T);return y=J?.remove,J}else throw new ae(`"${l}.${p}()" is not implemented on ${C}`,_.Unimplemented)});return p==="addListener"&&(D.remove=async()=>y()),D};return L.toString=()=>`${p.toString()}() { [capacitor code] }`,Object.defineProperty(L,"name",{value:p,writable:!1,configurable:!1}),L},Pe=oe("addListener"),Be=oe("removeListener"),St=(p,y)=>{const L=Pe({eventName:p},y),T=async()=>{const w=await L;Be({eventName:p,callbackId:w},y)},D=new Promise(w=>L.then(()=>w({remove:T})));return D.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await T()},D},ie=new Proxy({},{get(p,y){switch(y){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return R?St:Pe;case"removeListener":return Be;default:return oe(y)}}});return s[l]=ie,d.set(l,{name:l,proxy:ie,platforms:new Set([...Object.keys(u),...R?[C]:[]])}),ie};return n.convertFileSrc||(n.convertFileSrc=l=>l),n.getPlatform=o,n.handleError=c,n.isNativePlatform=i,n.isPluginAvailable=a,n.registerPlugin=v,n.Exception=ae,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},Tt=e=>e.Capacitor=Bt(e),K=Tt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),B=K.registerPlugin;class ve{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,n){let s=!1;this.listeners[t]||(this.listeners[t]=[],s=!0),this.listeners[t].push(n);const i=this.windowListeners[t];i&&!i.registered&&this.addWindowListener(i),s&&this.sendRetainedArgumentsForEvent(t);const a=async()=>this.removeListener(t,n);return Promise.resolve({remove:a})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n,s){const o=this.listeners[t];if(!o){if(s){let i=this.retainedEventArguments[t];i||(i=[]),i.push(n),this.retainedEventArguments[t]=i}return}o.forEach(i=>i(n))}hasListeners(t){var n;return!!(!((n=this.listeners[t])===null||n===void 0)&&n.length)}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:s=>{this.notifyListeners(n,s)}}}unimplemented(t="not implemented"){return new K.Exception(t,_.Unimplemented)}unavailable(t="not available"){return new K.Exception(t,_.Unavailable)}async removeListener(t,n){const s=this.listeners[t];if(!s)return;const o=s.indexOf(n);this.listeners[t].splice(o,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const n=this.retainedEventArguments[t];n&&(delete this.retainedEventArguments[t],n.forEach(s=>{this.notifyListeners(t,s)}))}}const Te=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),De=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Dt extends ve{async getCookies(){const t=document.cookie,n={};return t.split(";").forEach(s=>{if(s.length<=0)return;let[o,i]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");o=De(o).trim(),i=De(i).trim(),n[o]=i}),n}async setCookie(t){try{const n=Te(t.key),s=Te(t.value),o=`; expires=${(t.expires||"").replace("expires=","")}`,i=(t.path||"/").replace("path=",""),a=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${n}=${s||""}${o}; path=${i}; ${a};`}catch(n){return Promise.reject(n)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const n of t)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}B("CapacitorCookies",{web:()=>new Dt});const xt=async e=>new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const o=s.result;t(o.indexOf(",")>=0?o.split(",")[1]:o)},s.onerror=o=>n(o),s.readAsDataURL(e)}),$t=(e={})=>{const t=Object.keys(e);return Object.keys(e).map(o=>o.toLocaleLowerCase()).reduce((o,i,a)=>(o[i]=e[t[a]],o),{})},Mt=(e,t=!0)=>e?Object.entries(e).reduce((s,o)=>{const[i,a]=o;let r,c;return Array.isArray(a)?(c="",a.forEach(d=>{r=t?encodeURIComponent(d):d,c+=`${i}=${r}&`}),c.slice(0,-1)):(r=t?encodeURIComponent(a):a,c=`${i}=${r}`),`${s}&${c}`},"").substr(1):null,At=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),o=$t(e.headers)["content-type"]||"";if(typeof e.data=="string")n.body=e.data;else if(o.includes("application/x-www-form-urlencoded")){const i=new URLSearchParams;for(const[a,r]of Object.entries(e.data||{}))i.set(a,r);n.body=i.toString()}else if(o.includes("multipart/form-data")||e.data instanceof FormData){const i=new FormData;if(e.data instanceof FormData)e.data.forEach((r,c)=>{i.append(c,r)});else for(const r of Object.keys(e.data))i.append(r,e.data[r]);n.body=i;const a=new Headers(n.headers);a.delete("content-type"),n.headers=a}else(o.includes("application/json")||typeof e.data=="object")&&(n.body=JSON.stringify(e.data));return n};class Ot extends ve{async request(t){const n=At(t,t.webFetchExtra),s=Mt(t.params,t.shouldEncodeUrlParams),o=s?`${t.url}?${s}`:t.url,i=await fetch(o,n),a=i.headers.get("content-type")||"";let{responseType:r="text"}=i.ok?t:{};a.includes("application/json")&&(r="json");let c,d;switch(r){case"arraybuffer":case"blob":d=await i.blob(),c=await xt(d);break;case"json":c=await i.json();break;default:c=await i.text()}const v={};return i.headers.forEach((l,u)=>{v[u]=l}),{data:c,headers:v,status:i.status,url:i.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}B("CapacitorHttp",{web:()=>new Ot});var xe;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(xe||(xe={}));var $e;(function(e){e.StatusBar="StatusBar",e.NavigationBar="NavigationBar"})($e||($e={}));class Rt extends ve{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}}B("SystemBars",{web:()=>new Rt});const x=B("PushNotifications",{}),Ut="modulepreload",_t=function(e){return"/"+e},Me={},H=function(t,n,s){let o=Promise.resolve();if(n&&n.length>0){let c=function(d){return Promise.all(d.map(v=>Promise.resolve(v).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");o=c(n.map(d=>{if(d=_t(d),d in Me)return;Me[d]=!0;const v=d.endsWith(".css"),l=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${l}`))return;const u=document.createElement("link");if(u.rel=v?"stylesheet":Ut,v||(u.as="script"),u.crossOrigin="",u.href=d,r&&u.setAttribute("nonce",r),document.head.appendChild(u),v)return new Promise((O,C)=>{u.addEventListener("load",O),u.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return o.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})},jt=B("Browser",{web:()=>H(()=>import("./web-Dn9hjnIe.js"),[]).then(e=>new e.BrowserWeb)}),qt=B("App",{web:()=>H(()=>import("./web-mWOcmnsX.js"),[]).then(e=>new e.AppWeb)}),Ht=B("Motion",{android:()=>H(()=>import("./web-BnWSHzYq.js"),[]).then(e=>new e.MotionWeb),ios:()=>H(()=>import("./web-BnWSHzYq.js"),[]).then(e=>new e.MotionWeb),web:()=>H(()=>import("./web-BnWSHzYq.js"),[]).then(e=>new e.MotionWeb)});var le;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(le||(le={}));var Ae;(function(e){e.None="NONE",e.Slide="SLIDE",e.Fade="FADE"})(Ae||(Ae={}));const Oe=B("StatusBar");var Re;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(Re||(Re={}));var Ue;(function(e){e.Body="body",e.Ionic="ionic",e.Native="native",e.None="none"})(Ue||(Ue={}));const Wt=B("Keyboard"),Nt={apiKey:"AIzaSyDupdTnEuyuFOwypK7tqIuCgmU_tHDcYiY",authDomain:"private-dddb2.firebaseapp.com",projectId:"private-dddb2",storageBucket:"private-dddb2.firebasestorage.app",messagingSenderId:"93498096619",appId:"1:93498096619:web:c0ea372d7e6f86170a77ae",measurementId:"G-B5C8C34XT5",databaseURL:"https://private-dddb2-default-rtdb.firebaseio.com"};try{firebase.initializeApp(Nt)}catch{console.error("Firebase Init Error: Please replace firebaseConfig with actual values.")}const g=firebase.database(),_e=firebase.messaging(),Ft="BJ0uCMTncHrN6Way3i8qoagoN71lcE7PrSNl6E2zUJv2Rv8x4WczsSjId7wUVT2qoPbfGbJQmcjmPVA1kiwsTEE",zt="2009";let m=null,E=null,V=null;const M=new Set,re=localStorage.getItem("savedUser");re?(console.log("Restoring background notifications for:",re),ue(re)):ue(null);function ue(e){K.isNativePlatform()?vn(e):pn(e)}const me=document.getElementById("login-screen"),je=document.getElementById("username-select"),ge=document.getElementById("pin-input"),Kt=document.getElementById("login-btn"),qe=document.getElementById("login-error"),Q=document.getElementById("chat-screen"),Vt=document.getElementById("chat-with-name"),He=document.getElementById("typing-indicator"),ce=document.getElementById("last-seen"),j=document.getElementById("chat-container"),A=document.getElementById("message-input"),Xt=document.getElementById("send-btn"),Gt=document.getElementById("msg-sound"),ee=document.getElementById("image-input"),pe=document.getElementById("doc-input");document.getElementById("doc-btn");const W=document.getElementById("image-modal"),Yt=document.getElementById("modal-img"),Jt=document.getElementById("close-modal"),et=document.getElementById("reply-preview"),Qt=document.getElementById("reply-sender"),Zt=document.getElementById("reply-text"),en=document.getElementById("close-reply"),tt=document.getElementById("options-btn"),X=document.getElementById("options-dropdown"),tn=document.getElementById("clear-chat-btn"),nt=document.getElementById("emoji-btn"),Z=document.getElementById("emoji-picker-container"),nn=document.querySelector("emoji-picker"),de=document.getElementById("app-notification");document.getElementById("notification-msg");document.querySelector(".close-notification");const sn=document.getElementById("search-btn"),st=document.getElementById("search-bar-container"),G=document.getElementById("search-input"),on=document.getElementById("search-back-btn"),fe=document.getElementById("search-clear-btn"),We=document.getElementById("search-controls"),an=document.getElementById("search-counter"),rn=document.getElementById("search-up-btn"),cn=document.getElementById("search-down-btn"),he=document.getElementById("plus-camera-btn"),N=document.getElementById("plus-btn"),I=document.getElementById("plus-menu"),Ne=document.getElementById("plus-doc-btn"),Fe=document.getElementById("plus-gallery-btn"),ze=document.getElementById("plus-drawing-btn"),te=document.getElementById("drawing-modal"),f=document.getElementById("drawing-canvas"),Ke=document.getElementById("close-drawing"),Ve=document.getElementById("send-drawing"),Xe=document.getElementById("clear-drawing"),F=document.querySelectorAll(".color-swatch"),ye=document.getElementById("camera-modal"),$=document.getElementById("camera-stream"),U=document.getElementById("camera-canvas"),dn=document.getElementById("close-camera"),ln=document.getElementById("capture-btn"),un=document.getElementById("switch-camera"),q=document.getElementById("camera-preview"),ot=document.getElementById("camera-controls"),it=document.getElementById("preview-controls"),mn=document.getElementById("retake-btn"),at=document.getElementById("send-photo-btn"),gn=document.getElementById("panic-btn"),fn=document.getElementById("panic-overlay");let k=null,z="user";Kt.addEventListener("click",mt);Xt.addEventListener("click",Ee);A.addEventListener("keypress",e=>{e.key==="Enter"&&Ee()});A.addEventListener("input",ft);ee.addEventListener("change",ht);pe.addEventListener("change",Ln);N&&N.addEventListener("click",e=>{e.stopPropagation(),I.classList.toggle("hidden"),N.classList.toggle("active")});document.addEventListener("click",e=>{I&&!I.classList.contains("hidden")&&!N.contains(e.target)&&!I.contains(e.target)&&(I.classList.add("hidden"),N.classList.remove("active"))});Ne&&Ne.addEventListener("click",()=>{pe.click(),I.classList.add("hidden")});Fe&&Fe.addEventListener("click",()=>{ee.click(),I.classList.add("hidden")});he&&he.addEventListener("click",()=>{Ce(),I.classList.add("hidden")});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&rt()});qt.addListener("appStateChange",({isActive:e})=>{e||rt()});function rt(){Q.classList.contains("hidden")||(console.log("App Backgrounded: Auto-Locking..."),Q.classList.add("hidden"),me.classList.remove("hidden"),ge.value="",console.log("Session locked. Re-entry required."))}j.addEventListener("click",e=>{e.target.classList.contains("msg-image")&&(W.classList.remove("hidden"),Yt.src=e.target.src)});Jt.addEventListener("click",()=>{W.classList.add("hidden")});W.addEventListener("click",e=>{e.target===W&&W.classList.add("hidden")});en.addEventListener("click",ke);tt.addEventListener("click",e=>{e.stopPropagation(),X.classList.toggle("hidden"),Z.classList.add("hidden")});document.addEventListener("click",e=>{!tt.contains(e.target)&&!X.contains(e.target)&&X.classList.add("hidden"),!nt.contains(e.target)&&!Z.contains(e.target)&&Z.classList.add("hidden")});tn.addEventListener("click",Et);nt.addEventListener("click",e=>{e.stopPropagation(),Z.classList.toggle("hidden"),X.classList.add("hidden")});nn.addEventListener("emoji-click",e=>{A.value+=e.detail.unicode,A.focus()});de.addEventListener("click",e=>{if(e.target.classList.contains("close-notification")){de.classList.add("hidden"),e.stopPropagation();return}window.open("https://www.tradingview.com/","_blank"),de.classList.add("hidden")});sn.addEventListener("click",()=>{st.classList.remove("hidden"),G.focus()});on.addEventListener("click",()=>{st.classList.add("hidden"),G.value="",we("")});fe.addEventListener("click",()=>{G.value="",G.focus(),we("")});let P=[],b=-1;rn.addEventListener("click",()=>ct(-1));cn.addEventListener("click",()=>ct(1));G.addEventListener("input",e=>{const t=e.target.value;t.length>0?fe.classList.remove("hidden"):fe.classList.add("hidden"),we(t)});function we(e){const t=document.querySelectorAll(".message"),n=e.toLowerCase();P=[],b=-1,t.forEach(s=>{s.style.removeProperty("display");const o=s.querySelector(".msg-text"),i=s.querySelector(".doc-name");let a=!1;if(o){o.hasAttribute("data-original")||o.setAttribute("data-original",o.textContent);const r=o.getAttribute("data-original");if(e==="")o.textContent=r;else if(r.toLowerCase().includes(n)){a=!0;const c=new RegExp(`(${e})`,"gi"),d=r.replace(c,'<span class="highlight-text">$1</span>');o.innerHTML=d}else o.textContent=r}else i&&i.textContent.toLowerCase().includes(n)&&e!==""&&(a=!0);a&&P.push(s)}),e!==""&&P.length>0?(We.classList.remove("hidden"),b=P.length-1,dt(),lt(b)):We.classList.add("hidden")}function ct(e){P.length!==0&&(b+=e,b<0&&(b=P.length-1),b>=P.length&&(b=0),dt(),lt(b))}function dt(){an.textContent=`${b+1} of ${P.length}`}function lt(e){const t=P[e];t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-message"),setTimeout(()=>t.classList.remove("highlight-message"),1e3))}he.addEventListener("click",Ce);dn.addEventListener("click",bt);ln.addEventListener("click",It);un.addEventListener("click",Lt);mn.addEventListener("click",se);const ut=e=>{e.preventDefault(),xn()};at.addEventListener("click",ut);at.addEventListener("touchstart",ut);gn.addEventListener("click",Le);window.downloadFile=(e,t)=>{const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)};const hn="0000";function mt(){const e=je.value,t=ge.value;if(!e){Ge("Please select a user.");return}if(t===hn){Le(),me.classList.add("hidden"),ge.value="",je.value="";return}if(t!==zt){Ge("Incorrect PIN.");return}m=e,E=m==="XAU/USD"?"BTC/USD":"XAU/USD",me.classList.add("hidden"),Q.classList.remove("hidden"),Vt.textContent=E.charAt(0).toUpperCase()+E.slice(1),wn(),En(),localStorage.setItem("savedUser",m),ue(m)}async function vn(e){let t=await x.checkPermissions();if(t.receive==="prompt"&&(t=await x.requestPermissions()),t.receive!=="granted"){console.log("User denied permissions!");return}await x.register(),await x.removeAllListeners(),x.addListener("registration",n=>{console.log("Push Registration Token: ",n.value),gt(n.value,e)}),x.addListener("registrationError",n=>{console.error("Error on registration: ",n)}),x.addListener("pushNotificationReceived",n=>{console.log("Push received: ",n)}),x.addListener("pushNotificationActionPerformed",async n=>{console.log("Push action performed: ",n);const s=n.notification.data,o=s&&s.url?s.url:"https://www.tradingview.com/";await jt.open({url:o})})}function pn(e){if(!("serviceWorker"in navigator)){console.log("Service Worker not supported");return}navigator.serviceWorker.register("./firebase-messaging-sw.js").then(t=>(console.log("Service Worker registered with scope:",t.scope),_e.getToken({vapidKey:Ft,serviceWorkerRegistration:t}))).then(t=>{t?(console.log("FCM Token:",t),gt(t,e)):(console.log("No registration token available. Request permission to generate one."),Notification.requestPermission().then(n=>{n==="granted"&&console.log("Notification permission granted.")}))}).catch(t=>{console.log("An error occurred while retrieving token. ",t)}),_e.onMessage(t=>{console.log("Message received. ",t)})}function gt(e,t){let n=localStorage.getItem("deviceId");n||(n="device_"+Math.random().toString(36).substr(2,9),localStorage.setItem("deviceId",n)),g.ref(`tokens/devices/${n}`).set(e);const s=t||m;s&&g.ref(`tokens/users/${s}/${n}`).set(e)}async function yn(){if(!E)return;const e=await g.ref(`tokens/users/${E}`).once("value");if(!e.exists())return;const t=e.val();Object.values(t).forEach(s=>{fetch("/api/send-push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:s,title:"Market opens ‚Ä¶",body:""})}).catch(o=>console.error("API Push Error",o))})}function Ge(e){qe.textContent=e,setTimeout(()=>qe.textContent="",3e3)}function wn(){const e=g.ref("messages");e.limitToLast(100).on("child_added",n=>{const s=n.val();Cn(s,n.key),s.sender!==m&&!s.seen&&In(n.key),s.sender!==m&&(Gt.play().catch(()=>{}),s.seen||document.visibilityState==="hidden"&&kn("Market opens ‚Ä¶",""))}),e.limitToLast(100).on("child_changed",n=>{const s=n.val();if(s.deleted){const o=document.querySelector(`.message[data-key="${n.key}"]`);if(o){const i=o.querySelector(".msg-text");i&&(i.textContent="üö´ This message was deleted",i.className="msg-text deleted-msg",i.setAttribute("data-original","This message was deleted"));const a=o.querySelector(".msg-image");a&&a.remove();const r=o.querySelector(".document-bubble");r&&r.remove();const c=o.querySelector(".msg-reactions");c&&c.remove();const d=o.cloneNode(!0);o.parentNode.replaceChild(d,o)}}else Mn(n.key,s.reactions);M.has(n.key)||Ie(n.key,s.seen)}),e.on("child_removed",n=>{const s=document.querySelector(`.message[data-key="${n.key}"]`);s&&s.remove()}),g.ref(`status/${E}/typing`).on("value",n=>{n.val()?He.textContent="typing...":He.textContent=""}),g.ref(`status/${E}`).on("value",n=>{const s=n.val();if(s)if(s.online)ce.textContent="Online";else if(s.lastOnline){const o=new Date(s.lastOnline);ce.textContent=`Last seen at ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}else ce.textContent=""})}function En(){const e=g.ref(`status/${m}`),t={online:!1,lastOnline:firebase.database.ServerValue.TIMESTAMP},n={online:!0,lastOnline:firebase.database.ServerValue.TIMESTAMP};g.ref(".info/connected").on("value",s=>{s.val()!==!1&&e.onDisconnect().update(t).then(()=>{e.update(n)})})}function Ee(){const e=A.value.trim();if(!e)return;const t={sender:m,receiver:E,text:e,timestamp:Date.now(),seen:!1,replyTo:V||null};g.ref("messages").push(t),A.value="",ke(),g.ref(`status/${m}/typing`).set(!1),yn()}let Ye;function ft(){g.ref(`status/${m}/typing`).set(!0),clearTimeout(Ye),Ye=setTimeout(()=>{g.ref(`status/${m}/typing`).set(!1)},2e3)}function ht(e){const t=e.target.files[0];if(!t)return;ee.value="";const n=new FileReader;n.onload=s=>{const o=new Image;o.onload=()=>{const i=document.createElement("canvas"),a=600,r=600;let c=o.width,d=o.height;c>d?c>a&&(d*=a/c,c=a):d>r&&(c*=r/d,d=r),i.width=c,i.height=d,i.getContext("2d").drawImage(o,0,0,c,d);const l=i.toDataURL("image/jpeg",.7);ne(l)},o.src=s.target.result},n.readAsDataURL(t)}function ne(e){const t={sender:m,receiver:E,text:"üì∑ Photo",image:e,timestamp:Date.now(),seen:!1},s=g.ref("messages").push(),o=s.key;M.add(o),s.set(t).then(()=>{M.delete(o);const i=document.querySelector(`.message[data-key="${o}"]`);if(i){const a=i.querySelector(".img-loading-overlay");a&&a.remove(),Ie(o,!1)}}).catch(i=>{console.log("Image Send Failed",i);const a=document.getElementById(`status-${o}`);a&&(a.innerHTML='<span style="color:red">!</span>')}),g.ref(`status/${m}/typing`).set(!1),sendFCMNotification(E,"New Photo from "+m,"üì∑ Photo")}function Ln(e){const t=e.target.files[0];if(!t)return;if(pe.value="",t.size>100*1024*1024){alert("File size exceeds 100MB limit.");return}const n=new FileReader;n.onload=s=>{const o=s.target.result;bn(t,o)},n.readAsDataURL(t)}function bn(e,t){const n={sender:m,receiver:E,text:`üìÑ ${e.name}`,file:{name:e.name,size:e.size,type:e.type,data:t},timestamp:Date.now(),seen:!1},o=g.ref("messages").push(),i=o.key;M.add(i),o.set(n).then(()=>{M.delete(i);const a=document.querySelector(`.message[data-key="${i}"]`);if(a){const r=a.querySelector(".doc-loading-spinner");r&&r.remove(),Ie(i,!1)}}).catch(a=>{console.error("Doc Send Error",a);const r=document.getElementById(`status-${i}`);r&&(r.innerHTML='<span style="color:red">!</span>')}),g.ref(`status/${m}/typing`).set(!1)}function In(e){g.ref(`messages/${e}`).update({seen:!0})}function kn(e,t){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(n){n.showNotification(e,{body:t,icon:"/icon.png",tag:`market-${Date.now()}`,renotify:!0,data:{url:"https://www.tradingview.com/"}})})}function Cn(e,t){const n=e.sender===m,s=document.createElement("div");s.classList.add("message"),s.classList.add(n?"outgoing":"incoming"),s.setAttribute("data-key",t);const o=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let i="";if(e.sender===m)if(M.has(t))i=`<span id="status-${t}" class="status-icon pending-icon">üïí</span>`;else{const c=e.seen?"seen":"";i=`<span id="status-${t}" class="status-icon ${c}">
                <svg viewBox="0 0 16 15" width="16" height="15" fill="currentColor">
                    <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033L4.023 6.045a.364.364 0 0 0-.513.041l-.383.432a.364.364 0 0 0 .046.513l4.743 4.31a.318.318 0 0 0 .484-.033l6.59-8.498a.363.363 0 0 0-.063-.51l.083.016z"/>
                    <path d="M11.383 1.36l-.478-.372a.365.365 0 0 0-.51.063L4.566 8.679a.32.32 0 0 1-.484.033L1.09 5.86a.418.418 0 0 0-.541.036L.141 6.314a.319.319 0 0 0 .032.484l3.52 2.953c.143.14.361.125.473-.018l6.837-7.234a.418.418 0 0 0-.063-.526z"/>
                </svg>
            </span>`}let a="";e.replyTo&&(a=`
            <div class="reply-quote" data-reply-id="${e.replyTo.id}">
                <div class="reply-quote-sender">${e.replyTo.sender===m?"You":e.replyTo.sender}</div>
                <div class="reply-quote-text">${e.replyTo.text}</div>
            </div>
        `),s.innerHTML=`
        ${a}
        ${(()=>{if(e.deleted)return'<div class="msg-text deleted-msg">üö´ This message was deleted</div>';if(e.file){const c=M.has(t);return`
                <div class="document-bubble" onclick="downloadFile('${e.file.data}', '${e.file.name}')">
                    <div class="doc-icon">${e.file.name.split(".").pop()}</div>
                    <div class="doc-info">
                        <span class="doc-name">${e.file.name}</span>
                        <span class="doc-meta">${(e.file.size/1024).toFixed(1)} KB ‚Ä¢ ${e.file.name.split(".").pop().toUpperCase()}</span>
                    </div>
                    ${c?'<div class="doc-loading-spinner" style="margin-left: 5px;">‚è≥</div>':`<div class="doc-download">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                        </svg>
                    </div>`}
                </div>`}else if(e.image){const c=M.has(t);return`
                <div style="position:relative; display:inline-block;">
                    <img src="${e.image}" class="msg-image" alt="Image">
                    ${c?'<div class="img-loading-overlay"><div class="spinner"></div></div>':""}
                </div>
                `}else return`<div class="msg-text">${Tn(e.text)}</div>`})()}
        <div class="msg-meta">
            <span class="timestamp">${o}</span>
            ${i}
        </div>
        <!-- Reactions Container -->
        <div class="msg-reactions ${e.reactions?"":"hidden"}" id="reactions-${t}">
            ${e.reactions?"‚ù§Ô∏è"+(Object.keys(e.reactions).length>1?" "+Object.keys(e.reactions).length:""):""}
        </div>
    `,j.appendChild(s);const r=s.querySelector(".msg-text");if(r&&r.setAttribute("data-original",e.deleted?"This message was deleted":e.text),s.addEventListener("dblclick",c=>{c.preventDefault(),c.stopPropagation(),e.deleted||wt(e,t)}),s.addEventListener("click",c=>{c.detail===3&&(c.preventDefault(),c.stopPropagation(),e.deleted||($n(t,e.reactions),ke()))}),!e.deleted&&e.sender===m){s.addEventListener("contextmenu",v=>{if(v.preventDefault(),Date.now()-e.timestamp>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&Ze(t)});let d;s.addEventListener("touchstart",v=>{d=setTimeout(()=>{if(Date.now()-e.timestamp>6e5){alert("You can only delete messages within 10 minutes of sending.");return}confirm("Delete this message for everyone?")&&Ze(t)},800)}),s.addEventListener("touchend",()=>{clearTimeout(d)}),s.addEventListener("touchmove",()=>{clearTimeout(d)})}if(e.deleted||Dn(s,e,t),e.image&&!e.deleted){const c=s.querySelector("img");c&&(c.onload=Qe)}Qe(),e.replyTo&&s.querySelector(".reply-quote").addEventListener("click",d=>{d.stopPropagation();const v=e.replyTo.id,l=document.querySelector(`.message[data-key="${v}"]`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),l.classList.add("highlight-message"),setTimeout(()=>{l.classList.remove("highlight-message")},1e3))})}function Le(){console.log("INITIATING PANIC PROTOCOL"),g.ref("messages").set(null).then(()=>{console.log("Database Wiped.")}),g.ref("messages").off(),fn.classList.remove("hidden"),j.innerHTML="",document.getElementById("chat-screen").classList.add("hidden"),document.title="BTC/USD Chart",K.isNativePlatform()&&(Wt.hide().catch(console.error),Oe.setStyle({style:le.Dark}).catch(console.error),Oe.setBackgroundColor({color:"#131722"}).catch(console.error)),navigator.vibrate&&navigator.vibrate([200,100,200])}let h,be=!1;ze&&ze.addEventListener("click",()=>{te.classList.remove("hidden"),I&&I.classList.add("hidden"),setTimeout(vt,10)});function vt(){const e=te.querySelector(".drawing-area");if(!e)return;const t=e.clientWidth,n=e.clientHeight;f.width=t,f.height=n,h=f.getContext("2d"),h.lineCap="round",h.lineJoin="round",h.lineWidth=3,h.strokeStyle="#000000",F.forEach(s=>s.classList.remove("active")),F[0]&&F[0].classList.add("active")}f.addEventListener("mousedown",Sn);f.addEventListener("mouseup",pt);f.addEventListener("mousemove",yt);f.addEventListener("mouseleave",pt);f.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches[0],n=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY});f.dispatchEvent(n)},{passive:!1});f.addEventListener("touchend",e=>{e.preventDefault();const t=new MouseEvent("mouseup",{});f.dispatchEvent(t)},{passive:!1});f.addEventListener("touchmove",e=>{e.preventDefault();const t=e.touches[0],n=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY});f.dispatchEvent(n)},{passive:!1});function Sn(e){be=!0,yt(e)}function pt(){be=!1,h&&h.beginPath()}function yt(e){if(!be||!h)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,s=e.clientY-t.top;h.lineTo(n,s),h.stroke(),h.beginPath(),h.moveTo(n,s)}Xe&&Xe.addEventListener("click",()=>{h&&h.clearRect(0,0,f.width,f.height)});Ke&&Ke.addEventListener("click",()=>{te.classList.add("hidden")});F.forEach(e=>{e.addEventListener("click",t=>{F.forEach(s=>s.classList.remove("active")),t.target.classList.add("active");const n=t.target.getAttribute("data-color");h&&(h.strokeStyle=n)})});Ve&&Ve.addEventListener("click",async()=>{console.log("Send Drawing Clicked - Start");try{const e=f.toDataURL("image/png");console.log("Canvas to DataURL success, length:",e.length),ne(e),console.log("sendImageMessage called")}catch(e){console.error("Critical Error sending drawing:",e)}finally{console.log("Entering Finally Block - Forcing Close");const e=document.getElementById("drawing-modal");e?(e.classList.add("hidden"),e.style.display="none",setTimeout(()=>{e.style.display=""},500),console.log("Modal Closed via Class + Style")):console.error("FATAL: Modal element not found in DOM during close"),h&&(h.clearRect(0,0,f.width,f.height),console.log("Canvas Cleared"))}});window.addEventListener("resize",()=>{te.classList.contains("hidden")||vt()});const Pn=40;let Je=0;async function Bn(){try{await Ht.addListener("accel",e=>{const{x:t,y:n,z:s}=e.acceleration;if(t===null)return;const o=Math.abs(t)+Math.abs(n)+Math.abs(s);if(o>Pn){const i=Date.now();i-Je>1e3&&(console.log("Violent Shake Detected! Magnitude:",o),Je=i,Q.classList.contains("hidden")||Le())}}),console.log("Shake detection armed.")}catch(e){console.error("Shake Support Error:",e)}}Bn();function Ie(e,t){const n=document.getElementById(`status-${e}`);n&&(t?n.classList.add("seen"):n.classList.remove("seen"))}function Qe(){j.scrollTop=j.scrollHeight}function Tn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Dn(e,t,n){let s=0,o=0;e.addEventListener("touchstart",i=>{s=i.touches[0].clientX,e.classList.add("swiping")},{passive:!0}),e.addEventListener("touchmove",i=>{o=i.touches[0].clientX;const a=o-s;a>0&&a<100&&(e.style.transform=`translateX(${a}px)`)},{passive:!0}),e.addEventListener("touchend",i=>{e.classList.remove("swiping"),o-s>50&&wt(t,n),e.style.transform="translateX(0)",s=0,o=0})}function wt(e,t){V={id:t,text:e.image?"üì∑ Photo":e.text,sender:e.sender},Qt.textContent=e.sender===m?"You":e.sender,Zt.textContent=V.text,et.classList.remove("hidden"),A.focus()}function Ze(e){g.ref(`messages/${e}`).update({deleted:!0,text:"üö´ This message was deleted",image:null,file:null}).then(()=>{console.log("Message deleted successfully.")}).catch(t=>{console.error("Error deleting message:",t)})}function ke(){V=null,et.classList.add("hidden")}function Et(){X.classList.add("hidden"),confirm("Are you sure you want to clear this chat? It will be deleted for both sides.")&&g.ref("messages").remove().then(()=>{j.innerHTML=""}).catch(e=>{console.error("Remove failed: "+e.message),alert("Failed to clear chat: "+e.message)})}function Ce(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("Camera not supported or permission denied.");return}ye.classList.remove("hidden"),Se()}function Se(){k&&k.stop();const e={video:{facingMode:z},audio:!1};navigator.mediaDevices.getUserMedia(e).then(function(t){$.srcObject=t,k=t.getTracks()[0]}).catch(function(t){console.error("Camera Error: "+t),alert("Could not access camera: "+t.message),z==="environment"?(z="user",Se()):ye.classList.add("hidden")})}function Lt(){z=z==="user"?"environment":"user",Se()}function bt(){ye.classList.add("hidden"),k&&(k.stop(),k=null),$.srcObject=null}function It(){if(!k)return;U.width=$.videoWidth,U.height=$.videoHeight,U.getContext("2d").drawImage($,0,0,U.width,U.height);const t=U.toDataURL("image/jpeg",.8);q.src=t,$.classList.add("hidden"),q.classList.remove("hidden"),ot.classList.add("hidden"),it.classList.remove("hidden")}function se(){q.classList.add("hidden"),$.classList.remove("hidden"),it.classList.add("hidden"),ot.classList.remove("hidden"),q.src=""}function xn(){console.log("confirmSendPhoto called");const e=q.src;try{e?(ne(e),console.log("Photo sent via sendImageMessage")):console.warn("confirmSendPhoto: No dataUrl found")}catch(t){console.error("Error sending photo:",t)}finally{console.log("confirmSendPhoto: Forcing close"),bt();const t=document.getElementById("camera-modal");t&&(t.classList.add("hidden"),t.style.display="none",setTimeout(()=>t.style.display="",500)),setTimeout(se,300)}}window.handleLogin=mt;window.handleTyping=ft;window.handleImageSelect=ht;window.handleClearChat=Et;window.sendMessage=Ee;window.capturePhoto=It;window.openCamera=Ce;window.closeCameraModal=function(){const e=document.getElementById("camera-modal");e.classList.add("hidden"),e.style.display="none",k&&(k.stop(),k=null),$.srcObject=null,setTimeout(()=>{e.style.display=""},500)};window.retakePhoto=se;window.switchCamera=Lt;window.confirmSendPhoto=function(){window.closeCameraModal();const e=q.src;e&&ne(e),setTimeout(se,300)};window.imageInput=ee;function $n(e,t){g.ref(`messages/${e}/reactions/${m}`).transaction(s=>s?null:"‚ù§Ô∏è")}function Mn(e,t){const n=document.getElementById(`reactions-${e}`);if(n)if(t){const s=Object.keys(t).length;n.textContent="‚ù§Ô∏è"+(s>1?" "+s:""),n.classList.remove("hidden")}else n.textContent="",n.classList.add("hidden")}export{ve as W};
